<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Coach ‚Äî Romandie Scooter League</title>

  <!-- Fonts + Styles globaux -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/common.css"/>

  <!-- Supabase + scripts site -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script defer src="js/env.js"></script>
  <script defer src="js/auth.js"></script>
  <script defer src="js/site.js"></script>

  <style>
    :root{
      --rsl-bg: #020617;
      --rsl-fg: #e5e7eb;
      --rsl-muted: #9ca3af;
      --rsl-card: rgba(15,23,42,.96);
      --rsl-card-soft: rgba(15,23,42,.9);
      --rsl-border: rgba(148,163,184,.45);
      --rsl-accent: #22c55e;
      --rsl-accent-soft: rgba(34,197,94,.14);
    }

    body.theme-light{
      --rsl-bg: #f3f4f6;
      --rsl-fg: #0f172a;
      --rsl-muted: #6b7280;
      --rsl-card: #ffffff;
      --rsl-card-soft: #f9fafb;
      --rsl-border: rgba(148,163,184,.35);
      --rsl-accent: #16a34a;
      --rsl-accent-soft: rgba(22,163,74,.12);
    }

    html, body {
      height:100%;
      margin:0;
    }
    body{
      background: transparent !important;
      color:var(--rsl-fg);
      font-family:"Outfit",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      display:flex;
      flex-direction:column;
      overflow-x:hidden;
    }
    main{flex:1;position:relative;z-index:10;}

    /* ===== VID√âO DE FOND ===== */
    .site-bg-video{
      position:fixed;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      z-index:-2;
      background:#000;
    }
    .site-bg-dim{
      position:fixed;
      inset:0;
      z-index:-1;
      background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.9));
      transition:background .25s ease;
    }
    body.theme-light .site-bg-dim{
      background:linear-gradient(180deg,rgba(249,250,251,.9),rgba(15,23,42,.85));
    }

    /* ===== NAVBAR (align√©e sur index) ===== */
    nav.nav {
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom:1px solid rgba(15,23,42,.8);
      transition:background .25s ease, border-color .25s ease, box-shadow .25s ease;
    }
    body.theme-light nav.nav{
      background:rgba(248,250,252,.96);
      border-bottom:1px solid rgba(148,163,184,.5);
      box-shadow:0 10px 30px rgba(15,23,42,.06);
    }
    nav.nav .container {
      max-width:1320px;
      margin:0 auto;
      padding:10px 18px;
    }
    nav.nav .row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:12px;
    }

    .brand {
      display:flex;
      align-items:center;
      gap:10px;
      color:inherit;
      text-decoration:none;
    }
    .brand img {
      height:42px;
      border-radius:10px;
      display:block;
      background:#fff;
      padding:3px;
      box-shadow:0 10px 28px rgba(0,0,0,.35);
    }
    .brand span {
      font-weight:800;
      letter-spacing:.2px;
      font-size:16px;
      white-space:nowrap;
    }

    nav.nav ul {
      display:flex;
      align-items:center;
      gap:20px;
    }
    nav.nav ul li { list-style:none; }
    nav.nav ul li a {
      font-weight:600;
      color:var(--rsl-fg);
      transition:.2s ease;
      font-size:15px;
      letter-spacing:.02em;
      white-space:nowrap;
      text-decoration:none;
      opacity:.9;
    }
    nav.nav ul li a:hover {
      color:var(--rsl-accent);
      opacity:1;
    }

    .cta {
      display:flex;
      align-items:center;
      gap:10px;
    }

    /* Boutons globaux (comme index) */
    .btn{
      border-radius:999px;
      padding:8px 14px;
      font-size:14px;
      font-weight:700;
      border:1px solid rgba(148,163,184,.5);
      text-decoration:none;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:rgba(15,23,42,.9);
      color:#f9fafb;
      transition:.2s ease;
    }
    body.theme-light .btn{
      background:#0f172a;
      color:#f9fafb;
      border-color:#0f172a;
    }
    .btn.green{
      background:var(--rsl-accent);
      color:#052e16;
      border-color:transparent;
      box-shadow:0 10px 26px rgba(22,163,74,.45);
    }
    .btn:hover{
      transform:translateY(-1px);
      filter:brightness(1.05);
    }

    .nav-avatar{
      width:34px;
      height:34px;
      border-radius:999px;
      object-fit:cover;
      border:2px solid var(--rsl-accent);
      box-shadow:0 0 10px rgba(34,197,94,.5);
    }

    /* Toggle th√®me */
    .theme-toggle{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      width:34px;
      height:34px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:17px;
      cursor:pointer;
      padding:0;
      transition:.2s ease;
    }
    .theme-toggle:hover{
      transform:translateY(-1px);
      filter:brightness(1.08);
    }
    body.theme-light .theme-toggle{
      background:#ffffff;
      color:#0f172a;
      border-color:rgba(148,163,184,.7);
    }

    #menuBtn{
      display:none;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:7px 10px;
      font-size:18px;
      line-height:1;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.4);
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      cursor:pointer;
      transition:.2s ease;
    }
    #menuBtn:hover{
      filter:brightness(1.1);
    }
    body.theme-light #menuBtn{
      background:#0f172a;
      color:#f9fafb;
      border-color:#0f172a;
    }

    .container{ max-width:1200px; margin:0 auto; padding:0 16px; }

    @media (max-width:990px){
      #menuBtn{ display:inline-flex; }
      nav.nav ul{ display:none !important; }
      #btnCart,
      .btn.green{
        display:none !important;
      }
    }

    /* ===== MENU MOBILE SLIDE ===== */
    .mobile-sheet{
      position:fixed;
      inset:0;
      display:none;
      z-index:120;
    }
    .mobile-sheet.open{ display:block; }
    .mobile-dim{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.5);
    }
    .mobile-panel{
      position:absolute;
      top:0;
      right:0;
      height:100%;
      width:82vw;
      max-width:360px;
      background:var(--rsl-card);
      padding:22px 18px;
      display:flex;
      flex-direction:column;
      gap:12px;
      border-left:1px solid rgba(255,255,255,.08);
      box-shadow:-12px 0 30px rgba(0,0,0,.35);
    }
    .mobile-panel a{
      color:var(--rsl-fg);
      text-decoration:none;
      font-weight:700;
      padding:8px 0;
      border-bottom:1px solid rgba(255,255,255,.1);
      font-size:14px;
    }
    .mobile-panel a:last-child{border-bottom:0;}
    .mobile-panel .coach-link{
      border-top:1px solid rgba(255,255,255,.12);
      margin-top:8px;
      padding-top:12px;
      font-weight:700;
    }

    /* ===== CONTENU COACH ===== */
    .container-main{
      max-width:1200px;
      margin:0 auto;
      padding:0 24px 40px;
      box-sizing:border-box;
    }

    .page-intro{
      color:var(--rsl-fg);
      text-align:left;
      padding:28px 0 8px;
    }
    .page-intro h1{
      margin:10px 0 6px;
      font-size:clamp(28px,4.2vw,42px);
      font-weight:800;
    }
    .page-intro p{
      margin:0;
      opacity:.95;
      font-size:clamp(15px,2.2vw,18px);
    }
    .coach-welcome{
      margin-top:6px;
      font-size:14px;
      color:var(--rsl-muted);
    }

    .coach-info{
      margin-top:10px;
      font-size:14px;
      color:var(--rsl-muted);
    }

    .coach-status{
      margin-top:10px;
      padding:8px 10px;
      border-radius:10px;
      font-size:14px;
      background:var(--rsl-card);
      border:1px solid var(--rsl-border);
      color:var(--rsl-fg);
    }
    .coach-status.error{
      border-color:rgba(248,113,113,.8);
      color:#fecaca;
      background:rgba(127,29,29,.85);
    }

    .coach-grid{
      margin-top:18px;
      display:grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, .9fr);
      gap:22px;
    }
    @media(max-width:900px){
      .coach-grid{
        grid-template-columns:1fr;
      }
    }

    .coach-card{
      background:var(--rsl-card);
      border:1px solid var(--rsl-border);
      border-radius:16px;
      padding:18px 16px;
      box-shadow:0 10px 26px rgba(0,0,0,.45);
    }
    .coach-card h2{
      margin:0 0 6px;
      font-size:20px;
      color:var(--rsl-accent);
    }
    .coach-card p{
      margin:4px 0;
      font-size:14px;
      color:var(--rsl-fg);
    }
    .coach-card ul{
      margin:6px 0 0;
      padding-left:18px;
      font-size:14px;
      color:#cbd5f5;
    }

    /* Liste des cours pour coach */
    #coachCourses{
      margin-top:8px;
    }
    .course-item{
      background:rgba(15,23,42,.95);
      border-radius:12px;
      border:1px solid rgba(148,163,184,.35);
      padding:12px;
      margin-bottom:10px;
      font-size:14px;
      color:#e5e7eb;
    }
    body.theme-light .course-item{
      background:#ffffff;
      color:#0f172a;
    }
    .course-header{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }
    .course-title{
      font-weight:700;
      font-size:15px;
      margin:0 0 3px;
    }
    .course-meta{
      font-size:13px;
      color:#cbd5e1;
    }
    body.theme-light .course-meta{
      color:#6b7280;
    }
    .course-badge{
      display:inline-block;
      border-radius:999px;
      padding:3px 8px;
      font-size:11px;
      border:1px solid rgba(148,163,184,.7);
      color:#e5e7eb;
      background:rgba(15,23,42,.9);
      white-space:nowrap;
    }
    .course-badge.full{
      border-color:rgba(248,113,113,.9);
      color:#fecaca;
      background:rgba(127,29,29,.9);
    }
    .course-badge.coach{
      border-color:rgba(34,197,94,.9);
      color:#bbf7d0;
      background:rgba(22,163,74,.25);
      margin-left:6px;
    }

    .course-bottom{
      margin-top:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .coach-btn{
      border-radius:10px;
      border:0;
      padding:7px 12px;
      font-size:13px;
      font-weight:700;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 8px 22px rgba(0,0,0,.4);
    }
    .coach-btn.primary{
      background:#22c55e;
      color:#062312;
    }
    .coach-btn.outline{
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.7);
      box-shadow:none;
    }
    .coach-btn[disabled]{
      opacity:.6;
      cursor:not-allowed;
      box-shadow:none;
    }
    .coach-note{
      font-size:12px;
      color:#94a3b8;
    }

    .course-enrollments{
      margin-top:10px;
      font-size:13px;
      color:#cbd5e1;
      border-top:1px dashed rgba(148,163,184,.5);
      padding-top:6px;
    }
    .course-enrollments ul{
      margin:4px 0 0;
      padding-left:18px;
    }

    /* FOOTER */
    .footer-mini .copy{
      text-align:center;
      color:var(--rsl-muted);
      font-size:14px;
      padding:24px 0 28px;
      margin:0;
      border-top:1px solid rgba(15,23,42,.7);
      background: transparent;
    }
    body.theme-light .footer-mini .copy{
      background:rgba(248,250,252,.96);
      border-top-color:rgba(148,163,184,.5);
    }

    /* ===== MODAL RESTRICTION COACH ===== */
    .coach-modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.88);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:200;
    }
    .coach-modal-backdrop.open{
      display:flex;
    }
    .coach-modal{
      background:rgba(15,23,42,1);
      border-radius:16px;
      border:1px solid rgba(148,163,184,.6);
      padding:20px 18px;
      max-width:360px;
      width:90%;
      box-shadow:0 20px 40px rgba(0,0,0,.6);
      text-align:center;
    }
    .coach-modal h3{
      margin:0 0 8px;
      font-size:18px;
      color:#f9fafb;
    }
    .coach-modal p{
      margin:0 0 14px;
      font-size:14px;
      color:#e5e7eb;
    }
    .coach-modal .coach-modal-actions{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .coach-modal a,
    .coach-modal button{
      border-radius:10px;
      border:1px solid rgba(148,163,184,.7);
      padding:7px 14px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      text-decoration:none;
    }
    .coach-modal a.primary{
      background:#22c55e;
      color:#062312;
      border-color:#22c55e;
    }
  </style>
</head>
<body>

  <!-- VID√âO DE FOND -->
  <video class="site-bg-video" autoplay muted loop playsinline id="rslBg" poster="images/hero-poster.jpg"></video>
  <div class="site-bg-dim" aria-hidden="true"></div>

  <!-- NAV (comme index) -->
  <nav class="nav">
    <div class="container">
      <div class="row">
        <a class="brand" href="index.html">
          <img src="images/logo_rsl.png" alt="Logo RSL"/>
          <span>RSL ‚Äî Romandie Scooter League</span>
        </a>

        <ul>
          <li><a href="cours.html">Cours</a></li>
          <li><a href="formation.html">Formation RSL</a></li>
          <li><a href="ou_rider.html">O√π rider ?</a></li>
          <li><a href="evenements.html">√âv√©nements</a></li>
          <li><a href="disciplines.html">Disciplines</a></li>
          <li><a href="shop-rsl.html">Shop</a></li>
          <li><a href="comite.html">Comit√©</a></li>
          <li><a href="contact.html">Contact</a></li>
        </ul>

        <div class="cta">
          <!-- Toggle th√®me -->
          <button id="themeToggle" class="theme-toggle" aria-label="Changer le th√®me">üåô</button>

          <!-- Login / compte -->
          <a class="btn" id="btnLogin" href="access.html">Login</a>
          <a class="btn" id="btnAccount" href="compte.html" style="display:none">Mon compte</a>

          <!-- AVATAR NAV -->
          <a href="compte.html">
            <img id="navAvatar" class="nav-avatar" src="images/logo_rsl.png"
                 alt="Avatar" style="display:none;">
          </a>

          <a class="btn" id="btnCart" href="panier/panier.html">Panier</a>
          <a class="btn green" href="membres.html">Devenir membre</a>
          <button id="menuBtn">‚ò∞</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- MENU MOBILE -->
  <div class="mobile-sheet" id="mobileMenu">
    <div class="mobile-dim"></div>
    <nav class="mobile-panel">
      <a href="index.html" aria-current="page">Accueil</a>
      <a href="cours.html">Cours</a>
      <a href="membres.html">Devenir membre</a>
      <a href="formation.html">Formation RSL</a>
      <a href="disciplines.html">Disciplines</a>
      <a href="ou_rider.html">O√π rider ?</a>
      <a href="evenements.html">√âv√©nements</a>
      <a href="game.html">Games</a>
      <a href="shop-rsl.html">Shop</a>
      <a href="comite.html">Comit√©</a>
      <a href="contact.html">Contact</a>
      <a href="conditions.html">Conditions g√©n√©rales</a>
      <a href="compte.html">Mon compte</a>
      <a href="coach.html" class="coach-link">üë®‚Äçüè´ Je suis coach</a>
    </nav>
  </div>

  <!-- CONTENU -->
  <main>
    <div class="container-main">
      <section class="page-intro">
        <h1>Disponibilit√©s coach</h1>
        <p>Choisis les cours sur lesquels tu es disponible pour coacher. Tu vois les dates, heures, lieux et les inscriptions, mais tu ne modifies rien ici.</p>
        <p id="coachWelcome" class="coach-welcome"></p>
        <div id="coachStatus" class="coach-status" style="display:none;"></div>
      </section>

      <section class="coach-grid">
        <article class="coach-card">
          <h2>R√¥le du coach</h2>
          <p>En te marquant dispo, tu indiques √† la RSL sur quels cr√©neaux tu peux encadrer les riders.</p>
          <ul>
            <li>Encadrer les cours trottinette (d√©butants, interm√©diaires, avanc√©s)</li>
            <li>Assurer la s√©curit√© et le bon fonctionnement au skatepark</li>
            <li>Collaborer avec l‚Äô√©quipe RSL sur les stages et les events</li>
          </ul>
          <p class="coach-info">
            ‚ÑπÔ∏è <b>Important :</b> ce n‚Äôest pas une confirmation automatique de coaching, mais une
            <b>disponibilit√©</b>. L‚Äô√©quipe te confirme ensuite en fonction des besoins.
          </p>
        </article>

        <article class="coach-card">
          <h2>R√©sum√©</h2>
          <p id="coachSummary">Chargement de tes disponibilit√©s‚Ä¶</p>
          <p class="coach-info">
            Tu peux cocher / d√©cocher autant que tu veux. Les cours pass√©s ou complets
            restent visibles pour l‚Äôhistorique, mais tu ne peux plus te marquer dispo dessus.
          </p>
        </article>
      </section>

      <section class="coach-card" style="margin-top:24px;">
        <h2>Liste des cours</h2>
        <p style="font-size:14px;color:#cbd5e1;margin-bottom:6px;">
          Les cours ci-dessous sont charg√©s directement depuis Supabase (table <code>courses</code> et <code>rsl_course_registrations</code>).
        </p>

        <!-- MENU D√âROULANT POUR TRIER / FILTRER PAR VILLE -->
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px;">
          <label for="cityFilter" style="font-size:14px;color:#cbd5e1;">Filtrer par ville :</label>
          <select
            id="cityFilter"
            style="min-width:180px;padding:6px 10px;border-radius:10px;border:1px solid rgba(148,163,184,.6);background:rgba(15,23,42,.9);color:#e5e7eb;font-size:14px;">
            <option value="">Toutes les villes</option>
          </select>
        </div>

        <div id="coachCourses">
          <!-- Liste des cours g√©n√©r√©e en JS -->
        </div>
      </section>
    </div>
  </main>

  <!-- MODAL RESTRICTION COACH -->
  <div id="coachModalBackdrop" class="coach-modal-backdrop">
    <div class="coach-modal">
      <h3 id="coachModalTitle">Acc√®s r√©serv√©</h3>
      <p id="coachModalText">
        Cette page est r√©serv√©e aux coachs RSL.
      </p>
      <div class="coach-modal-actions" id="coachModalActions">
        <!-- Boutons inject√©s en JS -->
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="footer-mini">
    <p class="copy">¬© 2026 ‚Äî RSL Romandie Scooter League. Tous droits r√©serv√©s.</p>
  </footer>

  <script>
    // ===== Th√®me (comme index) =====
    (function(){
      const STORAGE_KEY = 'rsl-theme';
      const body = document.body;
      const btn = document.getElementById('themeToggle');

      function applyTheme(theme){
        if(theme === 'light'){
          body.classList.add('theme-light');
          if(btn) btn.textContent = '‚òÄÔ∏è';
        }else{
          body.classList.remove('theme-light');
          if(btn) btn.textContent = 'üåô';
        }
      }

      let saved = null;
      try{ saved = localStorage.getItem(STORAGE_KEY); }catch(e){}
      if(!saved){
        const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
        saved = prefersLight ? 'light' : 'dark';
      }
      applyTheme(saved);

      if(btn){
        btn.addEventListener('click', ()=>{
          const current = body.classList.contains('theme-light') ? 'light' : 'dark';
          const next = current === 'light' ? 'dark' : 'light';
          applyTheme(next);
          try{ localStorage.setItem(STORAGE_KEY, next); }catch(e){}
        });
      }
    })();

    // ===== Vid√©o de fond =====
    (function(){
      const vids = [
        "https://jynxifufaauoxwzjapzq.supabase.co/storage/v1/object/public/videos_rsl/trottvideo1.mp4",
        "https://jynxifufaauoxwzjapzq.supabase.co/storage/v1/object/public/videos_rsl/trottvideo2.mp4"
      ];
      const pick = vids[Math.floor(Math.random()*vids.length)];
      const v = document.getElementById('rslBg');
      if(!v) return;

      const s = document.createElement('source');
      s.src = pick;
      s.type = 'video/mp4';
      v.appendChild(s);

      const start = () => {
        try{
          v.playbackRate = 0.6;
          const p = v.play();
          if(p && p.catch) p.catch(()=>{});
        }catch(e){}
      };

      start();

      document.addEventListener('visibilitychange', () => {
        if(document.hidden){
          v.pause();
        }else{
          start();
        }
      });
    })();

    // ===== Burger mobile =====
    const menuBtn=document.getElementById('menuBtn');
    const mobile=document.getElementById('mobileMenu');
    menuBtn?.addEventListener('click',e=>{
      e.stopPropagation();
      mobile.classList.add('open');
      mobile.setAttribute('aria-hidden','false');
    });
    mobile?.querySelector('.mobile-dim')?.addEventListener('click',()=>{
      mobile.classList.remove('open');
      mobile.setAttribute('aria-hidden','true');
    });
    document.addEventListener('keydown',e=>{
      if(e.key==='Escape'){
        mobile.classList.remove('open');
        mobile.setAttribute('aria-hidden','true');
      }
    });

    // ===== Avatar nav depuis localStorage (m√™me logique que compte) =====
    const navAvatar = document.getElementById('navAvatar');
    function getAvatarLS(){
      try{
        return localStorage.getItem('rsl_avatar') || null;
      }catch(e){ return null; }
    }
    function applyAvatar(){
      const stored = getAvatarLS();
      const src = stored || "images/logo_rsl.png";
      if(navAvatar){
        navAvatar.src = src;
        if(stored) navAvatar.style.display = "inline-block";
      }
    }
    applyAvatar();

    // ===== Supabase init (r√©utilise le client global) =====
    const SUPABASE_URL  = "https://jynxifufaauoxwzjapzq.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5bnhpZnVmYWF1b3h3emphcHpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzODI2NzcsImV4cCI6MjA3Njk1ODY3N30.vFPGhGakPIM3Xg5rn8_BrAXl6oJMJOssO780C9nXmr4";

    let sb = null;
    if (window.supabaseClient) {
      sb = window.supabaseClient;
    } else if (window.supabase && window.supabase.createClient) {
      sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
      window.supabaseClient = sb;
    }

    let currentUser      = null;
    let isCoachProfile   = false;
    let coachAvail       = [];        // course_id (UUID) pour ce coach
    let courses          = [];        // liste des cours
    let cityFilter       = "";        // filtre par ville
    let reservedByOthers = new Set(); // course_id r√©serv√©s par un autre coach
    let registrationsByCourse = {};   // course_id -> [inscriptions]

    const coachStatusEl   = document.getElementById('coachStatus');
    const coachSummaryEl  = document.getElementById('coachSummary');
    const coachCoursesEl  = document.getElementById('coachCourses');
    const coachWelcomeEl  = document.getElementById('coachWelcome');
    const cityFilterEl    = document.getElementById('cityFilter');

    // Modal
    const coachModalBackdrop = document.getElementById('coachModalBackdrop');
    const coachModalTitle    = document.getElementById('coachModalTitle');
    const coachModalText     = document.getElementById('coachModalText');
    const coachModalActions  = document.getElementById('coachModalActions');

    function showStatus(msg, isError=false){
      if(!coachStatusEl) return;
      coachStatusEl.textContent = msg;
      coachStatusEl.style.display = 'block';
      coachStatusEl.classList.toggle('error', !!isError);
    }

    function formatDateFR(d){
      if(!(d instanceof Date) || isNaN(d.getTime())) return "";
      return d.toLocaleDateString('fr-CH', {
        weekday:'short', day:'2-digit', month:'2-digit'
      });
    }

    function formatTimeFR(d){
      if(!(d instanceof Date) || isNaN(d.getTime())) return "";
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return hh + "h" + mm;
    }

    function updateWelcome(profile){
      if(!coachWelcomeEl) return;
      if(!currentUser){
        coachWelcomeEl.textContent = "";
        return;
      }
      const name =
        profile?.full_name ||
        currentUser.user_metadata?.full_name ||
        currentUser.user_metadata?.name ||
        currentUser.email ||
        "coach";
      coachWelcomeEl.textContent = "Bienvenue " + name;
    }

    function updateSummary(){
      if(!coachSummaryEl) return;

      if(!currentUser){
        coachSummaryEl.textContent = "Connecte-toi pour voir et g√©rer tes disponibilit√©s.";
        return;
      }

      if(!isCoachProfile){
        coachSummaryEl.textContent = "Acc√®s r√©serv√© aux coachs RSL.";
        return;
      }

      const count = coachAvail.length;

      if(!count){
        coachSummaryEl.textContent = "Tu n‚Äôes marqu√© dispo sur aucun cours pour l‚Äôinstant.";
        return;
      }

      const dispoCourses = courses.filter(c => coachAvail.includes(String(c.id)));

      if(!dispoCourses.length){
        coachSummaryEl.textContent = "Tu es marqu√© dispo sur " + count + " cours.";
        return;
      }

      let html = "Tu es marqu√© dispo sur " + count + " cours :<br><ul style=\"margin-top:6px;padding-left:18px;\">";
      dispoCourses.forEach(c=>{
        const d = new Date(c.starts_at);
        const dateTxt = formatDateFR(d);
        const timeTxt = formatTimeFR(d);
        html += "<li>" + (c.location || "Lieu ?") + " ‚Äî " + dateTxt + " " + timeTxt + "</li>";
      });
      html += "</ul>";

      coachSummaryEl.innerHTML = html;
    }

    // ===== Modal helper =====
    function openRestrictionModal({ title, text, actions }){
      if(!coachModalBackdrop || !coachModalTitle || !coachModalText || !coachModalActions) return;
      coachModalTitle.textContent = title;
      coachModalText.textContent  = text;
      coachModalActions.innerHTML = "";

      (actions || []).forEach(a=>{
        if(a.type === 'link'){
          const link = document.createElement('a');
          link.href = a.href || '#';
          link.textContent = a.label || 'OK';
          if(a.primary) link.classList.add('primary');
          coachModalActions.appendChild(link);
        }else if(a.type === 'button'){
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = a.label || 'Fermer';
          btn.addEventListener('click', ()=>{
            coachModalBackdrop.classList.remove('open');
          });
          coachModalActions.appendChild(btn);
        }
      });

      coachModalBackdrop.classList.add('open');
    }

    coachModalBackdrop?.addEventListener('click', e=>{
      if(e.target === coachModalBackdrop){
        coachModalBackdrop.classList.remove('open');
      }
    });

    // ===== Restriction : seuls les coachs ont acc√®s fonctionnel =====
    async function loadUser(){
      if(!sb || !sb.auth){
        showStatus("Impossible de contacter Supabase (cl√© ou URL manquante).", true);
        return false;
      }
      try{
        const { data:{ user } } = await sb.auth.getUser();
        currentUser = user || null;

        // 1) PAS CONNECT√â
        if(!user){
          showStatus("Tu dois √™tre connect√© pour acc√©der √† cette page coach.", true);
          if(coachCoursesEl){
            coachCoursesEl.innerHTML = '<p style="color:#fca5a5">Connecte-toi pour acc√©der √† cette page coach.</p>';
          }

          openRestrictionModal({
            title: "Tu n‚Äôes pas connect√©",
            text:  "Cette page est r√©serv√©e aux coachs RSL connect√©s. Connecte-toi avec ton compte RSL.",
            actions:[
              { type:'link', label:'Me connecter', href:'compte.html', primary:true },
              { type:'button', label:'Fermer' }
            ]
          });

          updateSummary();
          return false;
        }

        // 2) CONNECT√â ‚Üí check profile
        const { data: profile } = await sb
          .from('profiles')
          .select('is_coach, full_name')
          .eq('id', user.id)
          .maybeSingle();

        isCoachProfile = !!profile?.is_coach;
        updateWelcome(profile || null);

        if(!isCoachProfile){
          showStatus("Acc√®s r√©serv√© aux coachs RSL. Contacte l‚Äô√©quipe pour √™tre ajout√© comme coach.", true);
          if(coachCoursesEl){
            coachCoursesEl.innerHTML =
              '<p style="color:#fca5a5">Acc√®s r√©serv√© aux coachs RSL.</p>';
          }

          openRestrictionModal({
            title: "Tu n‚Äôes pas encore coach",
            text:  "Cette page est r√©serv√©e aux coachs RSL. Si tu veux devenir coach, contacte-nous.",
            actions:[
              { type:'link', label:'Nous contacter', href:'contact.html#coach', primary:true },
              { type:'button', label:'Fermer' }
            ]
          });

          updateSummary();
          return false;
        }

        // 3) OK ‚Üí coach
        showStatus("Connect√© en tant que coach : " + (user.email || "coach"), false);
        updateSummary();
        return true;
      }catch(e){
        console.error(e);
        showStatus("Erreur lors du chargement de ta session.", true);
        return false;
      }
    }

    async function loadCoachAvail(){
      coachAvail = [];
      reservedByOthers = new Set();

      if(!sb || !currentUser || !isCoachProfile){
        updateSummary();
        return;
      }

      try{
        const { data, error } = await sb
          .from('rsl_coach_availabilities')
          .select('course_id,coach_id');

        if(error){
          console.error(error);
          showStatus("Erreur chargement disponibilit√©s : " + (error.message || error.code || ""), true);
          return;
        }

        (data || []).forEach(row=>{
          const cid = String(row.course_id);
          if(row.coach_id === currentUser.id){
            if(!coachAvail.includes(cid)) coachAvail.push(cid);
          }else{
            reservedByOthers.add(cid);
          }
        });

      }catch(e){
        console.error(e);
        showStatus("Erreur chargement disponibilit√©s : " + (e.message || ""), true);
      }

      updateSummary();
    }

    function buildCityOptions(){
      if(!cityFilterEl) return;
      const locations = Array.from(
        new Set(
          (courses || [])
            .map(c => c.location)
            .filter(Boolean)
        )
      ).sort((a,b)=>a.localeCompare(b,'fr'));

      cityFilterEl.innerHTML = '<option value="">Toutes les villes</option>' +
        locations.map(loc => `<option value="${loc}">${loc}</option>`).join('');
    }

    async function loadRegistrations(){
      registrationsByCourse = {};

      if(!sb || !courses.length) return;

      const courseIds = courses.map(c => c.id);

      try{
        const { data, error } = await sb
          .from('rsl_course_registrations')
          .select(`
            id,
            course_id,
            rider_first_name,
            rider_last_name,
            rider_age,
            parent_first_name,
            parent_last_name,
            parent_phone,
            parent_email,
            medical_note,
            membership_included,
            is_paid,
            course_is_paid,
            payment_status
          `)
          .in('course_id', courseIds);

        if(error){
          console.error("Erreur chargement inscriptions:", error);
          showStatus("Erreur chargement inscriptions : " + (error.message || error.code || ""), true);
          return;
        }

        (data || []).forEach(r=>{
          const cid = String(r.course_id);
          if(!registrationsByCourse[cid]) registrationsByCourse[cid] = [];
          registrationsByCourse[cid].push(r);
        });
      }catch(e){
        console.error("Erreur chargement inscriptions:", e);
        showStatus("Erreur chargement inscriptions.", true);
      }
    }

    async function loadCourses(){
      if(!sb){
        coachCoursesEl.innerHTML =
          '<p style="color:#fca5a5">Supabase non configur√©.</p>';
        return;
      }
      coachCoursesEl.innerHTML =
        '<p style="color:#e5e7eb">Chargement des cours‚Ä¶</p>';

      try{
        const { data, error } = await sb
          .from('courses')
          .select('id,location,starts_at,capacity')
          .order('starts_at', { ascending:true });

        if(error) throw error;

        courses = data || [];
      }catch(e){
        console.error(e);
        coachCoursesEl.innerHTML =
          '<p style="color:#fca5a5">Impossible de charger les cours : ' + (e.message || "") + '</p>';
        return;
      }

      await loadRegistrations();

      buildCityOptions();
      renderCourses();
      updateSummary();
    }

    function renderCourses(){
      if(!courses.length){
        coachCoursesEl.innerHTML =
          '<p style="color:#e5e7eb">Aucun cours pr√©vu pour l‚Äôinstant.</p>';
        return;
      }

      const now    = new Date();
      const filter = cityFilter || "";

      const filteredCourses = filter
        ? courses.filter(c => (c.location || "") === filter)
        : courses;

      if(!filteredCourses.length){
        coachCoursesEl.innerHTML =
          '<p style="color:#e5e7eb">Aucun cours ne correspond √† ce filtre.</p>';
        return;
      }

      const html = filteredCourses.map(c=>{
        const d = new Date(c.starts_at);
        const dateTxt = formatDateFR(d);
        const timeTxt = formatTimeFR(d);

        const cid  = String(c.id);
        const regs = registrationsByCourse[cid] || [];

        const taken = regs.length;
        const cap   = c.capacity || 0;
        const rest  = cap ? (cap - taken) : null;
        const isFull= rest !== null && rest <= 0;
        const inPast= d.getTime() + 2*60*60*1000 < now.getTime(); // 2h apr√®s d√©but

        const idStr          = cid;
        const isAvailable    = coachAvail.includes(idStr);
        const hasOtherCoach  = reservedByOthers.has(idStr);

        const badgeTxt =
          isFull ? 'Complet' :
          (rest === null ? (taken + " inscription(s)") :
           (taken + "/" + cap + " inscrits (" + rest + " places)"));

        const badgeClass = isFull ? 'course-badge full' : 'course-badge';

        let coachBadge = "";
        if(isAvailable){
          coachBadge = '<span class="course-badge coach">Tu es coach sur ce cours</span>';
        }else if(hasOtherCoach){
          coachBadge = '<span class="course-badge coach">Coach d√©j√† r√©serv√©</span>';
        }

        let btnLabel, btnDisabled = false;
        if(!currentUser || !isCoachProfile){
          btnLabel = "Acc√®s coach requis";
          btnDisabled = true;
        } else if (inPast){
          btnLabel = "Cours pass√©";
          btnDisabled = true;
        } else if (hasOtherCoach && !isAvailable){
          btnLabel = "D√©j√† r√©serv√©";
          btnDisabled = true;
        } else {
          btnLabel = isAvailable ? "Je ne suis plus dispo" : "Je suis dispo";
        }

        let enrollHtml = "";
        if(regs.length){
          const items = regs.map(r=>{
            const riderName =
              (r.rider_first_name || r.rider_last_name)
                ? `${r.rider_first_name || ""} ${r.rider_last_name || ""}`.trim()
                : "Rider (nom manquant)";
            const ageTxt = r.rider_age ? ` (${r.rider_age} ans)` : "";

            let paidFlag = "√† payer";
            const paid =
              r.membership_included === true ||
              r.is_paid === true ||
              r.course_is_paid === true ||
              (r.payment_status && r.payment_status.toLowerCase().includes("pay"));

            if(r.membership_included) paidFlag = "inclus abo";
            else if(paid) paidFlag = "pay√©";

            const phoneTxt = r.parent_phone ? ` ‚Äî T√©l parent: ${r.parent_phone}` : "";

            return `<li>${riderName}${ageTxt} ‚Äî ${paidFlag}${phoneTxt}</li>`;
          }).join("");

          enrollHtml = `
            <div class="course-enrollments">
              <strong>${regs.length} inscription(s) :</strong>
              <ul>${items}</ul>
            </div>
          `;
        }else{
          enrollHtml = `
            <div class="course-enrollments">
              <strong>0 inscription</strong> ‚Äî aucun rider pour l‚Äôinstant.
            </div>
          `;
        }

        return `
          <div class="course-item" data-course-id="${c.id}">
            <div class="course-header">
              <div>
                <p class="course-title">${c.location}</p>
                <p class="course-meta">
                  ${dateTxt} ‚Äî ${timeTxt}
                </p>
              </div>
              <div>
                <span class="${badgeClass}">
                  ${badgeTxt}
                </span>
                ${coachBadge}
              </div>
            </div>
            <div class="course-bottom">
              <button
                class="coach-btn ${isAvailable ? 'outline' : 'primary'}"
                data-role="toggle-availability"
                data-course-id="${c.id}"
                ${btnDisabled ? 'disabled' : ''}>
                ${btnLabel}
              </button>
              <span class="coach-note">
                ID cours: ${c.id}
              </span>
            </div>
            ${enrollHtml}
          </div>
        `;
      }).join('');

      coachCoursesEl.innerHTML = html;
    }

    // ===== Garde l'UUID tel quel + r√®gles de blocage =====
    async function toggleAvailability(courseId, btn){
      if(!currentUser || !isCoachProfile){
        showStatus("Acc√®s r√©serv√© aux coachs RSL.", true);
        return;
      }
      if(!sb) return;

      if(!courseId){
        showStatus("ID de cours manquant, impossible d‚Äôenregistrer.", true);
        console.error("courseId manquant sur le bouton", btn);
        return;
      }

      const cid          = String(courseId);
      const isAvailable  = coachAvail.includes(cid);
      const hasOtherCoach= reservedByOthers.has(cid);

      if(!isAvailable && hasOtherCoach){
        showStatus("Ce cours a d√©j√† un coach r√©serv√©.", true);
        return;
      }

      if(isAvailable){
        const course = courses.find(c => String(c.id) === cid);
        if(course){
          const start = new Date(course.starts_at);
          const now   = new Date();
          const diff  = start.getTime() - now.getTime();
          const sevenDaysMs = 7*24*60*60*1000;
          if(diff < sevenDaysMs){
            showStatus("Tu ne peux plus retirer ta dispo moins d‚Äôune semaine avant le cours.", true);
            return;
          }
        }
      }

      btn.disabled   = true;
      btn.textContent= "Mise √† jour‚Ä¶";

      try{
        if(isAvailable){
          const { error } = await sb
            .from('rsl_coach_availabilities')
            .delete()
            .eq('coach_id', currentUser.id)
            .eq('course_id', cid);

          if(error) throw error;

          coachAvail = coachAvail.filter(x => x !== cid);
          showStatus("Disponibilit√© retir√©e pour ce cours.");
        }else{
          const { data, error } = await sb
            .from('rsl_coach_availabilities')
            .insert({
              coach_id: currentUser.id,
              course_id: cid
            })
            .select('course_id')
            .maybeSingle();

          if(error) throw error;

          const newCid = data?.course_id ? String(data.course_id) : cid;
          if(!coachAvail.includes(newCid)){
            coachAvail.push(newCid);
          }
          showStatus("Tu es marqu√© dispo sur ce cours.");
        }
      }catch(e){
        console.error("Erreur insert/dispo coach:", e);
        const msg = (e && (e.message || e.code)) ? ` ${e.code || ''} ${e.message || ''}` : "";
        showStatus("Impossible d‚Äôenregistrer ta dispo pour ce cours." + msg, true);
      }

      updateSummary();
      renderCourses();
    }

    // ===== Login / Account basique (nav) =====
    (async function initAuthButtons(){
      if(!sb || !sb.auth) return;
      const btnLogin   = document.getElementById('btnLogin');
      const btnAccount = document.getElementById('btnAccount');

      try{
        const { data:{ user } } = await sb.auth.getUser();
        function ui(u){
          if(!btnLogin || !btnAccount) return;
          if(u){
            btnAccount.style.display = 'inline-flex';
            btnLogin.style.display   = 'none';
          } else {
            btnAccount.style.display = 'none';
            btnLogin.style.display   = 'inline-flex';
            btnLogin.textContent     = 'Login';
          }
        }
        ui(user);
        btnLogin?.addEventListener('click',()=>location.href='access.html');
        sb.auth.onAuthStateChange((_e,s)=>{
          currentUser = s?.user ?? null;
        });
      }catch(e){
        console.error(e);
      }
    })();

    // ===== Init globale =====
    document.addEventListener('DOMContentLoaded', async ()=>{
      const ok = await loadUser();  // true seulement si coach connect√©
      if(!ok) return;

      await loadCourses();
      await loadCoachAvail();

      if(cityFilterEl){
        cityFilterEl.addEventListener('change', ()=>{
          cityFilter = cityFilterEl.value || "";
          renderCourses();
        });
      }
    });

    // Click global pour les boutons "Je suis dispo"
    document.addEventListener('click',(e)=>{
      const btn = e.target.closest('[data-role="toggle-availability"]');
      if(!btn) return;
      const courseId = btn.dataset.courseId;
      if(!courseId) return;
      toggleAvailability(courseId, btn);
    });
  </script>
</body>
</html>
