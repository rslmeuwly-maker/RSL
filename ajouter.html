<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ajouter ‚Äî RSL</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --green:#22c55e;
    --green-dark:#16a34a;
    --panel:#0b1220;
    --border:rgba(255,255,255,.15);
    --dim:#9aa5b1;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:#000;color:#fff;
    font-family:Outfit,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  }

  .bg-wrap{position:fixed;inset:0;z-index:0;pointer-events:none}
  .bg-video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000;filter:brightness(.45)}

  header{
    position:sticky;top:0;z-index:10;
    display:flex;align-items:center;justify-content:space-between;
    padding:12px 14px;border-bottom:1px solid var(--border);
    background:rgba(0,0,0,.6);backdrop-filter:blur(8px);
  }
  header .brand{display:flex;align-items:center;gap:10px;color:#fff;text-decoration:none}
  header .brand img{height:34px;width:34px;border-radius:8px;background:#fff;padding:4px}
  header b{font-size:16px}
  header .auth{font-size:13px;color:var(--dim);font-weight:600}
  header .auth a{color:var(--green);font-weight:800;text-decoration:none}

  .wrap{position:relative;z-index:1;max-width:980px;margin:0 auto;padding:10px 12px 96px}

  .card{background:rgba(0,0,0,.72);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 30px 80px rgba(0,0,0,.85);margin-top:10px}
  h1{margin:0 0 8px;font-size:22px;font-weight:800}
  .muted{font-size:13px;color:var(--dim)}

  /* toggle post/story */
  .mode-toggle{display:inline-flex;border-radius:999px;padding:3px;background:#020617;border:1px solid rgba(148,163,184,.5);margin:10px 0}
  .mode-btn{border:0;background:transparent;color:#9ca3af;font-size:13px;font-weight:700;padding:7px 14px;border-radius:999px;cursor:pointer}
  .mode-btn.active{background:#0f172a;color:#fff;box-shadow:0 0 0 1px rgba(255,255,255,.15)}

  .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px}
  .input,.select{flex:1 1 220px;min-width:220px;padding:10px 12px;border-radius:10px;background:#0b1220;border:1px solid var(--border);color:#fff;font-family:inherit;font-size:14px;font-weight:600}
  textarea.input{min-height:70px;resize:vertical}

  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;background:linear-gradient(180deg,var(--green),var(--green-dark));color:#062312;border:0;border-radius:10px;font-weight:800;font-size:14px;padding:11px 14px;cursor:pointer;box-shadow:0 10px 24px rgba(0,0,0,.5)}
  .btn.secondary{background:rgba(15,23,42,.9);color:#e5e7eb;border:1px solid var(--border);box-shadow:none}

  .msg{font-size:13px;font-weight:700;margin-top:6px}

  /* upload pill */
  .upload-shell{flex:1 1 260px;min-width:240px}
  .file-pill{display:flex;align-items:center;gap:10px;padding:11px 14px;border-radius:12px;border:1px dashed rgba(255,255,255,.35);background:rgba(15,23,42,.95);cursor:pointer;font-size:14px;font-weight:700}
  .file-pill:hover{border-style:solid;border-color:var(--green);box-shadow:0 0 0 1px rgba(34,197,94,.35)}
  .file-pill .file-ic{font-size:18px}
  .file-pill .file-main{display:flex;flex-direction:column}
  .file-pill .file-title{font-weight:800}
  .file-pill .file-sub{font-size:11px;color:var(--dim)}
  .file-input{display:none}

  /* bottom nav */
  .tabbar{
    position:fixed;
    left:0;right:0;bottom:0;
    z-index:2000;
    display:flex;
    align-items:center;
    justify-content:space-around;
    padding:10px 12px;
    border-top:1px solid var(--border);
    background:rgba(0,0,0,.78);
    backdrop-filter:blur(10px);
  }
  .tab{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
    text-decoration:none;
  }
  .tab .ic{font-size:20px}
  .tab span{font-size:11px;color:#e5e7eb;font-weight:700}
  .tab.active span{color:#22c55e}
  @media(min-width:900px){.tab span{font-size:12px}}
</style>
</head>
<body>

<div class="bg-wrap" aria-hidden="true">
  <video class="bg-video" id="bgVid" autoplay muted loop playsinline preload="auto"></video>
</div>

<header>
  <a class="brand" href="ou_rider.html">
    <img src="images/logo_rsl.png" alt="RSL">
    <b>RSL ‚Äî Ajouter</b>
  </a>
  <div class="auth" id="authState">V√©rif session‚Ä¶</div>
</header>

<div class="wrap">
  <section class="card">
    <h1>Ajouter une publication</h1>
    <p class="muted">Choisis si tu publies dans le <b>feed</b> ou en <b>story 48h</b>.</p>

    <div class="mode-toggle">
      <button class="mode-btn active" id="btnModeFeed"  type="button">Post dans le feed</button>
      <button class="mode-btn"        id="btnModeStory" type="button">Story 48h</button>
    </div>

    <!-- Form FEED -->
    <form id="formFeed">
      <div class="row">
        <select id="fType" class="select">
          <option value="park">Skatepark / Pumptrack</option>
          <option value="street">Street spot</option>
        </select>
        <select id="fCanton" class="select">
          <option value="">Canton (optionnel)</option>
          <option value="VD">VD ‚Äî Vaud</option><option value="FR">FR ‚Äî Fribourg</option>
          <option value="VS">VS ‚Äî Valais</option><option value="GE">GE ‚Äî Gen√®ve</option>
          <option value="NE">NE ‚Äî Neuch√¢tel</option><option value="JU">JU ‚Äî Jura</option>
          <option value="BE">BE ‚Äî Berne</option><option value="ZH">ZH ‚Äî Zurich</option>
          <option value="TI">TI ‚Äî Tessin</option><option value="AUTRE">Autre / hors Suisse</option>
        </select>
        <select id="fSpot" class="select">
          <option value="">Pas de spot (optionnel)</option>
        </select>
      </div>

      <div class="row">
        <div class="upload-shell">
          <label for="fFile" class="file-pill">
            <div class="file-ic">üì∏</div>
            <div class="file-main">
              <span class="file-title" id="fFileLabel">Ajouter une photo / vid√©o</span>
              <span class="file-sub">Clip max ~20s pour les vid√©os</span>
            </div>
          </label>
          <input id="fFile" class="file-input" type="file" accept="image/*,video/*">
        </div>
        <textarea id="fCaption" class="input" maxlength="140" placeholder="L√©gende (ex: Double whip √† Vidy üî•)"></textarea>
      </div>

      <div class="row" style="align-items:center;justify-content:space-between">
        <button type="submit" class="btn">Publier dans le feed</button>
        <span class="muted">Les posts sont visibles dans le feed public RSL.</span>
      </div>
      <div id="feedMsg" class="msg"></div>
    </form>

    <!-- Form STORY -->
    <form id="formStory" style="display:none">
      <div class="row">
        <div class="upload-shell">
          <label for="sFile" class="file-pill">
            <div class="file-ic">‚ú®</div>
            <div class="file-main">
              <span class="file-title" id="sFileLabel">Ajouter une story</span>
              <span class="file-sub">Photo ou vid√©o verticale (48h)</span>
            </div>
          </label>
          <input id="sFile" class="file-input" type="file" accept="image/*,video/*">
        </div>
        <textarea id="sCaption" class="input" maxlength="120" placeholder="Texte de la story (optionnel)‚Ä¶"></textarea>
      </div>

      <div class="row" style="align-items:center;justify-content:space-between">
        <button type="submit" class="btn">Publier la story</button>
        <span class="muted">La story appara√Æt dans la barre en haut du feed pendant 48h.</span>
      </div>
      <div id="storyMsg" class="msg"></div>
    </form>
  </section>

  <p class="muted" style="margin-top:10px">
    Astuce : tu peux poster sans lier un spot, ou alors choisir Canton &amp; spot pour que les autres sachent o√π tu rides.
  </p>
</div>

<!-- bottom nav : Ajouter actif -->
<nav class="tabbar" aria-label="Navigation">
  <a class="tab" href="ou_rider.html" title="Carte / Spots">
    <div class="ic">üè†</div><span>Spots</span>
  </a>
  <a class="tab active" href="ajouter.html" title="Ajouter">
    <div class="ic">‚ûï</div><span>Ajouter</span>
  </a>
  <a class="tab" href="feed.html" title="Vid√©os">
    <div class="ic">üé¨</div><span>Feed</span>
  </a>
  <a class="tab" href="recherche.html" title="Recherche">
    <div class="ic">üîé</div><span>Recherche</span>
  </a>
  <a class="tab" href="profil_ou_rider.html" title="Profil">
    <div class="ic">üë§</div><span>Profil</span>
  </a>
</nav>

<script>
const SUPABASE_URL  = window.env?.SUPABASE_URL  || "https://jynxifufaauoxwzjapzq.supabase.co";
const SUPABASE_ANON = window.env?.SUPABASE_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5bnhpZnVmYWF1b3h3emphcHpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzODI2NzcsImV4cCI6MjA3Njk1ODY3N30.vFPGhGakPIM3Xg5rn8_BrAXl6oJMJOssO780C9nXmr4";
const supa = supabase.createClient(SUPABASE_URL,SUPABASE_ANON);

/* BG video */
(function(){
  const vids=[
    `${SUPABASE_URL}/storage/v1/object/public/videos_rsl/trottvideo1.mp4`,
    `${SUPABASE_URL}/storage/v1/object/public/videos_rsl/trottvideo2.mp4`
  ];
  const v=document.getElementById('bgVid');
  const s=document.createElement('source');
  s.src=vids[Math.floor(Math.random()*vids.length)];
  s.type="video/mp4"; v.appendChild(s);
  const play=()=>{try{v.playbackRate=0.6;const p=v.play();if(p&&p.catch)p.catch(()=>{});}catch(e){}};
  play(); document.addEventListener('visibilitychange',()=>{document.hidden?v.pause():play();});
})();

/* Auth */
let me=null, displayName=null;
const authState=document.getElementById('authState');
(async()=>{
  try{
    const { data:{ user } } = await supa.auth.getUser();
    if(user){
      me=user;
      displayName=user.user_metadata?.full_name || user.email || "Rider";
      authState.innerHTML=`Connect√© : <b>${displayName}</b>`;
    }else{
      authState.innerHTML=`Pas connect√© ‚Äî <a href="compte.html">Se connecter</a>`;
      document.getElementById('formFeed').style.opacity=".4";
      document.getElementById('formStory').style.opacity=".4";
    }
  }catch(e){
    authState.textContent="Session inconnue";
  }
})();

/* Toggle mode */
const btnModeFeed=document.getElementById('btnModeFeed');
const btnModeStory=document.getElementById('btnModeStory');
const formFeed=document.getElementById('formFeed');
const formStory=document.getElementById('formStory');

btnModeFeed.onclick=()=>{btnModeFeed.classList.add('active');btnModeStory.classList.remove('active');formFeed.style.display='block';formStory.style.display='none';};
btnModeStory.onclick=()=>{btnModeStory.classList.add('active');btnModeFeed.classList.remove('active');formFeed.style.display='none';formStory.style.display='block';};

/* Elements feed */
const fType=document.getElementById('fType');
const fCanton=document.getElementById('fCanton');
const fSpot=document.getElementById('fSpot');
const fFile=document.getElementById('fFile');
const fFileLabel=document.getElementById('fFileLabel');
const fCaption=document.getElementById('fCaption');
const feedMsg=document.getElementById('feedMsg');

/* Elements story */
const sFile=document.getElementById('sFile');
const sFileLabel=document.getElementById('sFileLabel');
const sCaption=document.getElementById('sCaption');
const storyMsg=document.getElementById('storyMsg');

/* Label fichiers */
fFile.addEventListener('change',()=>{fFileLabel.textContent=fFile.files?.[0]?.name || "Ajouter une photo / vid√©o";});
sFile.addEventListener('change',()=>{sFileLabel.textContent=sFile.files?.[0]?.name || "Ajouter une story";});

/* Chargement spots par canton (pr√©tri) */
async function loadSpotsForCanton(canton){
  if(!canton || canton==="AUTRE"){
    fSpot.innerHTML = '<option value="">Pas de spot (optionnel)</option>';
    return;
  }
  let html='<option value="">Pas de spot (optionnel)</option>';
  try{
    const { data:parks } = await supa.from('spots').select('id,nom,ville,canton').eq('canton',canton).limit(300);
    if(parks?.length){
      html+='<optgroup label="Parks">';
      parks.forEach(p=>{html+=`<option value="park:${p.id}">${p.nom} ‚Äî ${p.ville}</option>`;});
      html+='</optgroup>';
    }
  }catch(_){}
  try{
    const { data:streets } = await supa.from('bunny').select('id,nom,ville,canton').eq('canton',canton).limit(300);
    if(streets?.length){
      html+='<optgroup label="Street spots">';
      streets.forEach(s=>{html+=`<option value="street:${s.id}">${s.nom} ‚Äî ${s.ville}</option>`;});
      html+='</optgroup>';
    }
  }catch(_){}
  if(html=== '<option value="">Pas de spot (optionnel)</option>'){
    html+='<option disabled>Aucun spot pour ce canton (encore).</option>';
  }
  fSpot.innerHTML=html;
}
fCanton.addEventListener('change',()=>{loadSpotsForCanton(fCanton.value);});

/* Publier FEED */
formFeed.addEventListener('submit',async e=>{
  e.preventDefault();
  feedMsg.textContent='';
  if(!me){alert('Connecte-toi pour publier.');return;}

  const file=fFile.files?.[0] || null;
  if(!file){feedMsg.style.color='#f97373';feedMsg.textContent='Choisis une photo ou vid√©o.';return;}

  const pick=fSpot.value; // ex "park:12" ou ""
  const [spotType,spotIdStr] = (pick||'').split(':');
  const caption=(fCaption.value||'').trim();

  try{
    feedMsg.style.color='#e5e7eb';feedMsg.textContent='Upload en cours‚Ä¶';
    const safeName=file.name.replace(/[^\w.\-]+/g,'_');
    const path=`${me.id}/feed/${Date.now()}_${safeName}`;
    let { error:upErr } = await supa.storage.from('feed').upload(path,file,{upsert:false,contentType:file.type||undefined});
    if(upErr){
      const res2=await supa.storage.from('feed').upload(path,file,{upsert:true,contentType:file.type||undefined});
      upErr=res2.error;
      if(upErr) throw upErr;
    }
    const { data:pub } = supa.storage.from('feed').getPublicUrl(path);
    const mediaUrl=pub?.publicUrl;
    if(!mediaUrl) throw new Error('URL publique indisponible');

    const row={
      spot_id: spotIdStr ? Number(spotIdStr) : null,
      spot_type: spotType || null,
      user_id: me.id,
      user_display: displayName||'Rider',
      media_url: mediaUrl,
      caption
    };
    const { error } = await supa.from('spot_posts').insert([row]);
    if(error) throw error;

    feedMsg.style.color='#22c55e';feedMsg.textContent='Post publi√© ‚úÖ';
    fFile.value='';fFileLabel.textContent='Ajouter une photo / vid√©o';
    fCaption.value='';fSpot.value=''; // on garde type/canton
  }catch(err){
    feedMsg.style.color='#f97373';feedMsg.textContent='Erreur: '+(err?.message||'');
  }
});

/* Publier STORY */
formStory.addEventListener('submit',async e=>{
  e.preventDefault();
  storyMsg.textContent='';
  if(!me){alert('Connecte-toi pour publier.');return;}

  const file=sFile.files?.[0] || null;
  if(!file){storyMsg.style.color='#f97373';storyMsg.textContent='Choisis un m√©dia pour ta story.';return;}

  const caption=(sCaption.value||'').trim();

  try{
    storyMsg.style.color='#e5e7eb';storyMsg.textContent='Upload en cours‚Ä¶';
    const safeName=file.name.replace(/[^\w.\-]+/g,'_');
    const path=`${me.id}/flashes/${Date.now()}_${safeName}`;
    let { error:upErr } = await supa.storage.from('flashes').upload(path,file,{upsert:false,contentType:file.type||undefined});
    if(upErr){
      const res2=await supa.storage.from('flashes').upload(path,file,{upsert:true,contentType:file.type||undefined});
      upErr=res2.error;
      if(upErr) throw upErr;
    }
    const { data:pub } = supa.storage.from('flashes').getPublicUrl(path);
    const mediaUrl=pub?.publicUrl;
    if(!mediaUrl) throw new Error('URL publique indisponible');

    const expires = new Date(Date.now()+48*60*60*1000).toISOString();
    const { error } = await supa.from('flashes').insert([{ user_id:me.id, media_url:mediaUrl, caption, expires_at:expires }]);
    if(error) throw error;

    storyMsg.style.color='#22c55e';storyMsg.textContent='Story publi√©e ‚úÖ';
    sFile.value='';sFileLabel.textContent='Ajouter une story';
    sCaption.value='';
  }catch(err){
    storyMsg.style.color='#f97373';storyMsg.textContent='Erreur: '+(err?.message||'');
  }
});
</script>
</body>
</html>