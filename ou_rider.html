<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#22c55e">
<title>O√π rider ? ‚Äî Romandie Scooter League</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --green:#22c55e;
    --green-dark:#16a34a;
    --panel:#0b1220;
    --border:rgba(255,255,255,.15);
    --dim:#9aa5b1;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:#000;
    color:#fff;
    font-family:Outfit,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    display:flex;
    flex-direction:column;
  }
  main{flex:1}

  /* ===== BG vid√©o ===== */
  .rsl-bg-wrap{position:fixed;inset:0;z-index:0;pointer-events:none}
  .rsl-bg-video{
    position:absolute;inset:0;width:100%;height:100%;
    object-fit:cover;background:#000;
    filter:brightness(.55) saturate(1.05);
  }
  .rsl-bg-dim{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.55))}

  /* ===== NAV top ===== */
  nav.nav{
    position:sticky;top:0;z-index:1000;
    background:rgba(0,0,0,.65);
    backdrop-filter:blur(8px);
    border-bottom:1px solid rgba(255,255,255,.12);
  }
  nav .row{
    max-width:1200px;margin:0 auto;
    padding:12px 20px;
    display:flex;justify-content:space-between;align-items:center;
  }
  nav .brand{
    display:flex;
    align-items:center;
    gap:10px;
    font-weight:800;
  }
  nav .brand img{
    height:34px;
    width:34px;
    border-radius:8px;
    background:#fff;
    padding:4px;
  }

  nav a{color:#eaf5ee;text-decoration:none;font-weight:700}
  nav a:hover{color:#22c55e}

  /* ===== Titre ===== */
  .page-mini-hero{position:relative;z-index:10;padding:16px 0 6px}
  .page-mini-hero .container{max-width:1200px;margin:0 auto;padding:0 20px}
  .page-mini-hero h1{margin:0 0 6px;font-size:clamp(26px,4vw,38px);font-weight:800}

  /* ===== Carte ===== */
  main .container{max-width:1200px;margin:0 auto;padding:0 20px 120px;position:relative;z-index:10}
  .map-wrap{position:relative}
  #map{
    height:73vh;
    min-height:480px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.18);
    background:#0b1220;
  }
  @media(max-width:900px){
    #map{height:calc(100vh - 38vh);min-height:58vh}
  }
  .leaflet-pane,.leaflet-top,.leaflet-bottom{z-index:2}

  /* ===== Bouton Filtres (toujours visible) ===== */
  .filters-fab{
    position:absolute;
    right:12px;top:12px;
    z-index:3100;
    display:block;
  }
  .btn{
    appearance:none;
    border:1px solid var(--border);
    background:rgba(255,255,255,.06);
    color:#fff;
    border-radius:10px;
    padding:10px 12px;
    font:800 13px Outfit;
    cursor:pointer;
  }
  .btn.green{
    background:linear-gradient(180deg,var(--green),var(--green-dark));
    color:#062312;
    border:0;
  }
  .filters-fab .btn{filter:brightness(.85)}
  .filters-fab .btn{
    background:rgba(0,0,0,0.85)!important;
    border:1px solid #22c55e!important;
    box-shadow:0 0 8px rgba(34,197,94,.4);
  } /* un peu plus fonc√© */

  /* ===== Panneau Filtres ===== */
  .filters-wrap{
    position:absolute;
    top:12px;right:12px;
    z-index:3000;
    width:min(92vw,360px);
    display:none;
  }
  body.show-filters .filters-wrap{display:block}
  .filters-card{
    background:rgba(0,0,0,.78);
    border:1px solid rgba(255,255,255,.15);
    border-radius:14px;
    padding:12px;
    box-shadow:0 20px 60px rgba(0,0,0,.6);
    backdrop-filter:blur(6px) saturate(140%);
    max-height:70vh;
    overflow:auto;
  }
  .filters-grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:8px;
    margin-top:8px;
  }
  .chip{
    display:flex;align-items:center;gap:8px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
    padding:10px 12px;border-radius:10px;
    font:700 13px Outfit;
  }
  .chip input{width:18px;height:18px}
  .input,.select{
    width:100%;
    background:#0b1220;
    border:1px solid rgba(255,255,255,.18);
    border-radius:10px;
    color:#fff;
    padding:10px 12px;
    font:600 14px Outfit;
  }
  .filters-foot{
    display:flex;flex-wrap:wrap;gap:8px;
    margin-top:10px;
  }

  /* ===== Popups ===== */
  .leaflet-popup-content-wrapper{
    background:rgba(0,0,0,.85);
    border:1px solid rgba(34,197,94,.5);
    border-radius:14px;
    box-shadow:0 30px 60px rgba(0,0,0,.8);
    color:#fff;
  }
  .leaflet-popup-tip{
    background:rgba(0,0,0,.85);
    border:1px solid rgba(34,197,94,.5);
  }
  .leaflet-popup-content{margin:10px;min-width:200px;max-width:240px}
  .rsl-pop-title{font:700 14px/1.25 Outfit}
  .rsl-pop-loc{color:#9aa5b1;font:600 12px/1.3 Outfit;margin:2px 0 6px}
  .rsl-pop-desc{color:#cdd6ff;font:500 12px/1.4 Outfit;margin-bottom:8px}
  .rsl-pop-btn{
    display:inline-block;
    font:800 12px/1.2 Outfit;
    padding:8px 10px;
    border-radius:8px;
    background:linear-gradient(180deg,#22c55e,#16a34a);
    color:#062312;
    text-decoration:none;
  }

  /* ===== Modale ‚ÄúAjouter un spot‚Äù ===== */
  .modal{position:fixed;inset:0;z-index:4000;display:none}
  .modal.show{display:block}
  .modal-bg{position:absolute;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px)}
  .modal-card{
    position:relative;
    margin:6vh auto 0;
    max-width:min(92vw,720px);
    background:rgba(8,12,24,.95);
    border:1px solid rgba(255,255,255,.18);
    border-radius:16px;
    padding:14px;
  }
  .modal-card h3{margin:2px 0 10px;font-size:18px;font-weight:800}
  .modal .row{display:flex;gap:10px}
  .modal .row .col{flex:1}
  .modal input,.modal select,.modal textarea{
    width:100%;
    padding:10px 12px;
    border-radius:10px;
    background:#07101f;
    border:1px solid rgba(255,255,255,.16);
    color:#fff;
    font:600 14px Outfit;
  }
  .modal textarea{min-height:82px;resize:vertical}
  .modal .actions{
    display:flex;gap:8px;justify-content:flex-end;
    margin-top:10px;
  }
  #asMsg{font:700 12px;color:#7cffb0}
  #asMsg.error{color:#ff9f9f}
  @media(max-width:520px){ .modal .row{flex-direction:column} }

  /* ===== Tabbar (comme feed / recherche / profil / spot) ===== */
  .tabbar{
    position:fixed;
    left:0;right:0;bottom:0;
    z-index:2000;
    display:flex;
    align-items:center;
    justify-content:space-around;
    padding:10px 12px;
    border-top:1px solid var(--border);
    background:rgba(0,0,0,.78);
    backdrop-filter:blur(10px);
  }
  .tab{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
    text-decoration:none;
  }
  .tab .ic{font-size:20px}
  .tab span{font-size:11px;color:#e5e7eb;font-weight:700}
  .tab.active span{color:#22c55e}
  @media(min-width:900px){ .tab span{font-size:12px} }
</style>
</head>
<body>

<!-- BG vid√©o -->
<div class="rsl-bg-wrap" aria-hidden="true">
  <video class="rsl-bg-video" id="rslBg" autoplay muted loop playsinline preload="auto"></video>
  <div class="rsl-bg-dim"></div>
</div>

<!-- Nav top -->
<nav class="nav">
  <div class="row">
    <a class="brand" href="ou_rider.html">
      <img src="images/logo_rsl.png" alt="RSL"/>
      <span>RSL ‚Äî Romandie Scooter League</span>
    </a>
    <div style="display:flex;gap:14px;flex-wrap:wrap">
      <a href="feed.html">Feed</a>
      <a href="recherche.html">Recherche</a>
      <a href="membres.html">Devenir membre</a>
      <a href="compte.html">Mon compte</a>
    </div>
  </div>
</nav>

<!-- Titre -->
<section class="page-mini-hero">
  <div class="container">
    <h1>O√π rider ?</h1>
    <p style="margin:0;opacity:.95">
      Carte des <b>skateparks</b>, <b>street spots</b>, <b>shops partenaires</b> et <b>lieux de cours RSL</b>.
      Partage ta position, ou ajoute ton propre spot.
    </p>
  </div>
</section>

<!-- Carte + Filtres -->
<main>
  <div class="app-download" style="text-align:right;margin:10px 16px;">
    <button id="btnInstallOuRider"
            class="btn green"
            style="display:none;font-weight:800;padding:10px 16px;border-radius:10px;">
      üì≤ Installer l‚Äôapp O√π Rider
    </button>
  </div>

  <div class="container">
    <div class="map-wrap">

      <!-- bouton filtres -->
      <div class="filters-fab">
        <button id="btnToggleFilters" class="btn">Filtres</button>
      </div>

      <!-- panneau filtres -->
      <div class="filters-wrap" id="filtersWrap">
        <div class="filters-card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
            <b style="font:800 13px Outfit">Filtres</b>
            <button id="btnCloseFilters" class="btn" style="padding:6px 10px">‚úï</button>
          </div>

          <div class="filters-grid" style="margin-top:8px">
            <label class="chip"><input type="checkbox" id="f-park" checked/> Parks</label>
            <label class="chip"><input type="checkbox" id="f-street" checked/> Street</label>
            <label class="chip"><input type="checkbox" id="f-shop" checked/> Shops</label>
            <label class="chip"><input type="checkbox" id="f-cours" checked/> Cours</label>

            <select id="f-country" class="select">
              <option value="">Pays (tous)</option>
              <option value="CH">Suisse</option>
              <option value="FR">France</option>
              <option value="DE">Allemagne</option>
              <option value="EU">Autres Europe</option>
              <option value="WORLD">Monde</option>
            </select>

            <select id="f-canton" class="select"><option value="">Canton (CH)</option></select>

            <input id="f-type" class="input" placeholder="Type/texte (bowl, pumptrack, rail‚Ä¶)" />
          </div>

          <div class="filters-foot">
            <button id="btnReset" class="btn">R√©initialiser</button>
            <button id="btnLocate" class="btn green">üìç Ma position</button>
            <button id="btnShare" class="btn" title="Partage ta position avec les riders">Activer partage</button>
            <span id="shareState" style="font:600 12px Outfit;color:#9aa5b1;align-self:center"></span>
            <button id="btnAddSpot" class="btn green" style="margin-left:auto">‚ûï Ajouter un spot</button>
          </div>
        </div>
      </div>

      <div id="map"></div>
    </div>
  </div>
</main>

<!-- Tabbar -->
<nav class="tabbar" aria-label="Navigation">
  <a class="tab active" href="ou_rider.html" title="Carte / Spots">
    <div class="ic">üè†</div><span>Spots</span>
  </a>
  <a class="tab" href="ajouter.html" title="Ajouter">
    <div class="ic">‚ûï</div><span>Ajouter</span>
  </a>
  <a class="tab" href="feed.html" title="Vid√©os">
    <div class="ic">üé¨</div><span>Feed</span>
  </a>
  <a class="tab" href="recherche.html" title="Recherche">
    <div class="ic">üîé</div><span>Recherche</span>
  </a>
  <a class="tab" href="profil_ou_rider.html" title="Profil">
    <div class="ic">üë§</div><span>Profil</span>
  </a>
</nav>

<!-- Modale Ajouter un spot -->
<div class="modal" id="addSpotModal" aria-hidden="true">
  <div class="modal-bg"></div>
  <div class="modal-card">
    <h3>Proposer un nouveau spot</h3>

    <div class="row">
      <div class="col">
        <label style="font:800 12px Outfit;color:#e5e7eb">Type</label>
        <select id="asType">
          <option value="park">Park</option>
          <option value="street">Street</option>
        </select>
      </div>
      <div class="col">
        <label style="font:800 12px Outfit;color:#e5e7eb">Pays</label>
        <select id="asCountry">
          <option value="CH">Suisse</option>
          <option value="FR">France</option>
          <option value="DE">Allemagne</option>
          <option value="EU">Autres Europe</option>
          <option value="WORLD">Monde</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label style="font:800 12px Outfit;color:#e5e7eb">Canton (CH)</label>
        <select id="asCanton">
          <option value="">‚Äî</option>
          <option>GE</option><option>VD</option><option>VS</option><option>FR</option><option>NE</option>
          <option>JU</option><option>BE</option><option>ZH</option><option>ZG</option><option>BS</option>
          <option>BL</option><option>AR</option><option>AI</option><option>SG</option><option>GR</option>
          <option>TI</option><option>LU</option><option>UR</option><option>OW</option><option>NW</option>
          <option>GL</option><option>SH</option><option>SZ</option><option>SO</option><option>AG</option>
          <option>TG</option>
        </select>
      </div>
      <div class="col">
        <label style="font:800 12px Outfit;color:#e5e7eb">Ville</label>
        <input id="asVille" placeholder="Ville">
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label style="font:800 12px Outfit;color:#e5e7eb">Nom du spot</label>
        <input id="asNom" placeholder="Nom / rep√®re">
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label style="font:800 12px Outfit;color:#e5e7eb">Description</label>
        <textarea id="asDesc" placeholder="Rail, bowl, ledge‚Ä¶"></textarea>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label style="font:800 12px Outfit;color:#e5e7eb">Latitude</label>
        <input id="asLat" placeholder="Clique la carte" inputmode="decimal">
      </div>
      <div class="col">
        <label style="font:800 12px Outfit;color:#e5e7eb">Longitude</label>
        <input id="asLng" placeholder="Clique la carte" inputmode="decimal">
      </div>
    </div>

    <div id="asMsg" style="margin-top:6px">Clique la carte pour remplir lat/lng.</div>

    <div class="actions">
      <button id="asCancel" class="btn">Annuler</button>
      <button id="asSave" class="btn green" disabled>Envoyer</button>
    </div>
  </div>
</div>

<!-- env.js pour les vraies cl√©s -->
<script src="js/env.js"></script>
<script>
/* ===== Supabase + vid√©o ===== */
const SUPABASE_URL  = window.env?.SUPABASE_URL || "https://jynxifufaauoxwzjapzq.supabase.co";
const SUPABASE_ANON = window.env?.SUPABASE_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5bnhpZnVmYWF1b3h3emphcHpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzODI2NzcsImV4cCI6MjA3Njk1ODY3N30.vFPGhGakPIM3Xg5rn8_BrAXl6oJMJOssO780C9nXmr4";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// vid√©o fond
(function(){
  const vids = [
    `${SUPABASE_URL}/storage/v1/object/public/videos_rsl/trottvideo1.mp4`,
    `${SUPABASE_URL}/storage/v1/object/public/videos_rsl/trottvideo2.mp4`
  ];
  const v = document.getElementById('rslBg');
  const s = document.createElement('source');
  s.src = vids[Math.floor(Math.random()*vids.length)];
  s.type = "video/mp4";
  v.appendChild(s);
  const play = ()=>{ try{ v.playbackRate=.6; const p=v.play(); if(p&&p.catch) p.catch(()=>{});}catch(e){} };
  play();
  document.addEventListener('visibilitychange',()=>{ document.hidden? v.pause(): play(); });
})();

/* ===== Carte ===== */
let map = L.map('map').setView([46.8, 8.2], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19,
  attribution:'¬© OpenStreetMap'
}).addTo(map);

const mk = (bg, emoji='üõπ') => L.divIcon({
  className:'rsl-marker',
  html:`<div style="width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:${bg};border:2px solid #fff;color:#fff;font-size:18px">${emoji}</div>`,
  iconSize:[34,34], iconAnchor:[17,17]
});
const icons = {
  park:  mk('#7c3aed','üõπ'),
  street:mk('#f97316','üß±'),
  shop:  mk('#ef4444','üè™'),
  int:   mk('#16a34a','üè´'),
  ext:   mk('#0ea5e9','üõº'),
  rider: mk('#06b6d4','üë§')
};

const layers = {
  park:L.layerGroup().addTo(map),
  street:L.layerGroup().addTo(map),
  shop:L.layerGroup().addTo(map),
  int:L.layerGroup().addTo(map),
  ext:L.layerGroup().addTo(map),
  riders:L.layerGroup().addTo(map)
};

const ALL_MARKERS = []; // {marker, group, canton, country, text}

/* ===== Filtres UI ===== */
const body = document.body;
document.getElementById('btnToggleFilters').onclick = ()=> body.classList.toggle('show-filters');
document.getElementById('btnCloseFilters').onclick  = ()=> body.classList.remove('show-filters');
document.addEventListener('keydown',e=>{ if(e.key==='Escape') body.classList.remove('show-filters'); });

const F = {
  park:   document.getElementById('f-park'),
  street: document.getElementById('f-street'),
  shop:   document.getElementById('f-shop'),
  cours:  document.getElementById('f-cours'),
  country:document.getElementById('f-country'),
  canton: document.getElementById('f-canton'),
  type:   document.getElementById('f-type'),
  reset:  document.getElementById('btnReset'),
  locate: document.getElementById('btnLocate')
};

function applyFilters(){
  const show = {
    park:F.park.checked,
    street:F.street.checked,
    shop:F.shop.checked,
    int:F.cours.checked,
    ext:F.cours.checked
  };
  const cantonSel  = (F.canton.value||'').trim();
  const countrySel = (F.country.value||'').trim();
  const txt        = (F.type.value||'').trim().toLowerCase();

  ALL_MARKERS.forEach(o=>{
    let vis = !!show[o.group] || o.group==='riders';
    if(vis && countrySel && o.group!=='riders') vis = (o.country||'')===countrySel;
    if(vis && cantonSel && o.group!=='riders') vis = (o.canton||'')===cantonSel;
    if(vis && txt && o.group!=='riders') vis = (o.text||'').includes(txt);

    if(vis){
      if(!map.hasLayer(o.marker)) o.marker.addTo(layers[o.group]);
    }else{
      if(map.hasLayer(o.marker)) layers[o.group].removeLayer(o.marker);
    }
  });
}

['change','input'].forEach(ev=>{
  [F.park,F.street,F.shop,F.cours,F.country,F.canton,F.type].forEach(el=>{
    el.addEventListener(ev,applyFilters);
  });
});

F.reset.onclick = ()=>{
  F.park.checked = F.street.checked = F.shop.checked = F.cours.checked = true;
  F.country.value = '';
  F.canton.value  = '';
  F.type.value    = '';
  applyFilters();
};

F.locate.onclick = ()=>{
  if(!navigator.geolocation){ alert('G√©olocalisation indisponible.'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude,longitude} = pos.coords;
    L.circleMarker([latitude,longitude],{
      radius:6,color:'#38bdf8',fillColor:'#38bdf8',fillOpacity:.9,weight:2
    }).addTo(map);
    map.setView([latitude,longitude],14);
  },()=>alert("Impossible d'obtenir ta position."));
};

/* ===== Donn√©es Supabase ===== */
(async function loadData(){
  // shops
  let { data: shops } = await supa.from('shops').select('*');
  (shops||[]).forEach(s=>{
    if(!s.lat||!s.lng) return;
    const html = `
      <div class="rsl-pop">
        <div class="rsl-pop-title">${s.nom||'Shop'}</div>
        <div class="rsl-pop-loc">${s.ville||''} (${s.canton||''})</div>
        <div class="rsl-pop-desc">${s.description||''}</div>
        ${s.site?`<a class="rsl-pop-btn" href="${s.site}" target="_blank" rel="noopener">Site du shop ‚Üí</a>`:''}
      </div>`;
    const m = L.marker([s.lat,s.lng],{icon:icons.shop})
      .bindPopup(html,{closeButton:true,autoClose:false,closeOnClick:true});
    ALL_MARKERS.push({
      marker:m,
      group:'shop',
      canton:s.canton||'',
      country:s.country||'CH',
      text:`${s.nom||''} ${s.ville||''} ${s.description||''}`.toLowerCase()
    });
    m.addTo(layers.shop);
  });

  // parks
  let { data: parks } = await supa.from('spots').select('*');
  (parks||[]).forEach(p=>{
    if(!p.lat||!p.lng) return;
    const html = `
      <div class="rsl-pop">
        <div class="rsl-pop-title">${p.nom||'Spot'}</div>
        <div class="rsl-pop-loc">${p.ville||''} (${p.canton||''})</div>
        <div class="rsl-pop-desc">${p.description ? p.description : (p.type||'')}</div>
        <a class="rsl-pop-btn" href="spot.html?id=${p.id}" onclick="window.location.href='spot.html?id=${p.id}';return false;">Voir le spot ‚Üí</a>
      </div>`;
    const m = L.marker([p.lat,p.lng],{icon:icons.park})
      .bindPopup(html,{closeButton:true,autoClose:false,closeOnClick:true});
    const text = `${p.nom||''} ${p.ville||''} ${p.canton||''} ${p.type||''} ${p.description||''}`.toLowerCase();
    ALL_MARKERS.push({
      marker:m,
      group:'park',
      canton:p.canton||'',
      country:p.country||'CH',
      text
    });
    m.addTo(layers.park);
  });

  // street (bunny)
  let { data: streets } = await supa.from('bunny').select('*');
  (streets||[]).forEach(s=>{
    if(!s.lat||!s.lng) return;
    const html = `
      <div class="rsl-pop">
        <div class="rsl-pop-title">${s.nom||'Street spot'}</div>
        <div class="rsl-pop-loc">${s.ville||''} (${s.canton||''})</div>
        <div class="rsl-pop-desc">${s.description ? s.description : (s.type||'')}</div>
        <a class="rsl-pop-btn" href="spot.html?id=${s.id}&street=1" onclick="window.location.href='spot.html?id=${s.id}&street=1';return false;">Voir le spot ‚Üí</a>
      </div>`;
    const m = L.marker([s.lat,s.lng],{icon:icons.street})
      .bindPopup(html,{closeButton:true,autoClose:false,closeOnClick:true});
    const text = `${s.nom||''} ${s.ville||''} ${s.canton||''} ${s.type||''} ${s.description||''}`.toLowerCase();
    ALL_MARKERS.push({
      marker:m,
      group:'street',
      canton:s.canton||'',
      country:s.country||'CH',
      text
    });
    m.addTo(layers.street);
  });

  // lieux de cours (fixes)
  [
    {group:'int',  n:'Cours RSL ‚Äî Montreux (indoor)', lat:46.433, lng:6.910, desc:'Session encadr√©e en int√©rieur'},
    {group:'int',  n:'Cours RSL ‚Äî Lausanne (La Fi√®vre)', lat:46.536, lng:6.626, desc:'Cours en salle / rampes / park'},
    {group:'ext',  n:'Cours RSL ‚Äî Vidy', lat:46.523, lng:6.610, desc:'En ext√©rieur, bord du lac'},
  ].forEach(c=>{
    const html = `
      <div class="rsl-pop">
        <div class="rsl-pop-title">${c.n}</div>
        <div class="rsl-pop-desc">${c.desc||''}</div>
        <a class="rsl-pop-btn" href="cours.html">Infos cours ‚Üí</a>
      </div>`;
    const m = L.marker([c.lat,c.lng],{icon:icons[c.group]})
      .bindPopup(html,{closeButton:true,autoClose:false,closeOnClick:true});
    ALL_MARKERS.push({
      marker:m,
      group:c.group,
      canton:'',
      country:'CH',
      text:(c.n+' '+(c.desc||'')).toLowerCase()
    });
    m.addTo(layers[c.group]);
  });

  // remplir les cantons CH
  const cantons = new Set();
  ALL_MARKERS.forEach(o=>{ if(o.country==='CH' && o.canton) cantons.add(o.canton); });
  document.getElementById('f-canton').innerHTML =
    '<option value="">Canton (CH)</option>' +
    Array.from(cantons).sort().map(c=>`<option value="${c}">${c}</option>`).join('');

  applyFilters();
})();

/* ===== Partage position riders ===== */
let currentUser = null;
let watchId = null;
const shareBtn   = document.getElementById('btnShare');
const shareState = document.getElementById('shareState');

(async function(){
  try{
    const { data:{ user } } = await supa.auth.getUser();
    currentUser = user || null;
    updateShareUi(false, currentUser ? "Pr√™t √† partager" : "Connecte-toi pour partager");
  }catch(_){
    updateShareUi(false,"");
  }
})();

function updateShareUi(active, hint){
  shareBtn.textContent = active ? "Couper partage" : "Activer partage";
  shareBtn.classList.toggle('green', !active);
  if(hint!==undefined) shareState.textContent = hint || "";
}

async function upsertMyLocation(lat,lng){
  if(!currentUser) return;
  await supa.from('rider_locations').upsert({
    user_id: currentUser.id,
    lat, lng,
    updated_at: new Date().toISOString(),
    expires_at: new Date(Date.now() + 60*60*1000).toISOString()
  }, { onConflict:'user_id' });
}

async function removeMyLocation(){
  if(!currentUser) return;
  await supa.from('rider_locations').delete().eq('user_id', currentUser.id);
}

async function loadRiders(){
  const { data: rows } = await supa
    .from('rider_locations_view')
    .select('*')
    .gt('expires_at', new Date().toISOString());

  layers.riders.clearLayers();

  (rows||[]).forEach(r=>{
    if(currentUser && r.user_id===currentUser.id) return;
    if(!r.lat||!r.lng) return;
    const name = r.full_name || r.username || r.email || 'Rider';
    const popup = `
      <div class="rsl-pop">
        <div class="rsl-pop-title">${name}</div>
        <div class="rsl-pop-desc">Actif r√©cemment</div>
      </div>`;
    const m = L.marker([r.lat,r.lng],{icon:icons.rider})
      .bindPopup(popup,{closeButton:true});
    m.addTo(layers.riders);
  });
}

shareBtn.addEventListener('click', async ()=>{
  if(!currentUser){
    alert("Connecte-toi pour partager ta position.");
    return;
  }
  if(watchId!==null){
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
    updateShareUi(false,"Partage coup√©");
    await removeMyLocation();
    return;
  }
  if(!navigator.geolocation){
    alert("G√©olocalisation indisponible.");
    return;
  }
  updateShareUi(true,"Partage actif‚Ä¶");
  watchId = navigator.geolocation.watchPosition(async pos=>{
    await upsertMyLocation(pos.coords.latitude, pos.coords.longitude);
  }, err=>{
    console.warn(err);
    updateShareUi(false,"Autorise la g√©oloc");
    watchId = null;
  }, { enableHighAccuracy:true, maximumAge:8000, timeout:15000 });
});

setInterval(loadRiders, 20000);
loadRiders();

window.addEventListener('beforeunload', async ()=>{
  if(watchId!==null){
    try{ navigator.geolocation.clearWatch(watchId); }catch(_){}
    await removeMyLocation();
  }
});

/* ===== Modale Ajouter un spot ===== */
const addModal  = document.getElementById('addSpotModal');
const asType    = document.getElementById('asType');
const asCountry = document.getElementById('asCountry');
const asCanton  = document.getElementById('asCanton');
const asVille   = document.getElementById('asVille');
const asNom     = document.getElementById('asNom');
const asDesc    = document.getElementById('asDesc');
const asLat     = document.getElementById('asLat');
const asLng     = document.getElementById('asLng');
const asMsg     = document.getElementById('asMsg');
const asSaveBtn = document.getElementById('asSave');

document.getElementById('btnAddSpot').onclick = ()=> openAddModal();

function openAddModal(){
  addModal.classList.add('show');
  asMsg.classList.remove('error');
  asMsg.textContent='Clique la carte pour remplir lat/lng.';
  updateCantonVisibility();
  updateAsSaveState();
}

document.querySelector('#addSpotModal .modal-bg')
  .addEventListener('click',()=>addModal.classList.remove('show'));
document.getElementById('asCancel').onclick = ()=>addModal.classList.remove('show');

function updateCantonVisibility(){
  const isCH = (asCountry.value === 'CH');
  asCanton.parentElement.style.display = isCH ? '' : 'none';
  if(!isCH) asCanton.value = '';
}
asCountry.addEventListener('change', updateCantonVisibility);

function updateAsSaveState(){
  const ok = (asNom.value.trim().length>1 &&
              !!parseFloat(asLat.value) &&
              !!parseFloat(asLng.value));
  asSaveBtn.disabled = !ok;
  asSaveBtn.style.opacity = ok ? '1' : '.6';
}
['input','change'].forEach(ev=>{
  [asNom,asLat,asLng,asCountry,asCanton,asType,asVille,asDesc].forEach(el=>{
    el.addEventListener(ev,updateAsSaveState);
  });
});

// clic carte ‚Üí lat/lng dans la modale
map.on('click',e=>{
  if(!addModal.classList.contains('show')) return;
  asLat.value = e.latlng.lat.toFixed(6);
  asLng.value = e.latlng.lng.toFixed(6);
  updateAsSaveState();
});

// Envoi du nouveau spot
document.getElementById('asSave').onclick = async ()=>{
  asMsg.classList.remove('error');
  asMsg.textContent = "Envoi‚Ä¶";

  const row = {
    nom:(asNom.value||'').trim(),
    ville:(asVille.value||'').trim(),
    canton:(asCanton.value||'').trim(),
    country:(asCountry.value||'').trim() || (asCanton.value ? 'CH' : 'WORLD'),
    description:(asDesc.value||'').trim(),
    lat: parseFloat(asLat.value),
    lng: parseFloat(asLng.value)
  };

  if(!row.nom || !row.lat || !row.lng){
    asMsg.classList.add('error');
    asMsg.textContent = "Nom + position obligatoires.";
    return;
  }

  try{
    const target = (asType.value==='street') ? 'bunny' : 'spots';
    const { error } = await supa.from(target).insert([row]);
    if(error) throw error;

    const icon = (asType.value==='street') ? icons.street : icons.park;
    const text = `${row.nom} ${row.ville} ${row.canton} ${row.description}`.toLowerCase();
    const popup = `
      <div class="rsl-pop">
        <div class="rsl-pop-title">${row.nom}</div>
        <div class="rsl-pop-loc">${row.ville||''} (${row.canton||''})</div>
        <div class="rsl-pop-desc">${row.description||''}</div>
      </div>`;
    const m = L.marker([row.lat,row.lng],{icon})
      .bindPopup(popup,{closeButton:true});
    const g = (asType.value==='street') ? 'street' : 'park';

    ALL_MARKERS.push({
      marker:m,
      group:g,
      canton:row.canton||'',
      country:row.country||'WORLD',
      text
    });
    m.addTo(layers[g]);
    applyFilters();

    asMsg.textContent = "Spot propos√© ‚úÖ";
    setTimeout(()=>addModal.classList.remove('show'),600);
  }catch(ex){
    console.warn(ex);
    asMsg.classList.add('error');
    asMsg.textContent = "Erreur: "+(ex.message||'envoi impossible');
  }
};
</script>

<script>
  // Enregistre le service worker pour O√π Rider
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').catch(console.error);
  }

  // G√®re le bouton d'installation PWA
  let deferredPrompt = null;
  const btnInstall = document.getElementById('btnInstallOuRider');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    if (btnInstall) btnInstall.style.display = 'inline-flex';
  });

  if (btnInstall) {
    btnInstall.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      btnInstall.style.display = 'none';
    });
  }
</script>

</body>
</html>