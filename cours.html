<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cours — Romandie Scooter League</title>

<!-- Supabase + Stripe -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://js.stripe.com/v3/"></script>

<!-- Police -->
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f6f7fb; --ink:#0f172a; --muted:#475569;
  --card:#ffffff; --line:#e5e7eb;
  --accent:#ffc300; --cta:#16a34a;
  --disabled:#9ca3af; --radius:18px;
}
body{margin:0;font-family:Outfit,sans-serif;background:var(--bg);color:var(--ink)}
a{color:inherit;text-decoration:none}

/* NAV */
.nav{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
.nav .inner{max-width:1100px;margin:auto;padding:10px 14px;display:flex;align-items:center;gap:12px}
.nav .brand{display:flex;align-items:center;gap:10px}
.nav .brand img{height:34px}
.nav ul{display:flex;gap:14px;list-style:none;margin:0 0 0 auto;padding:0}
.nav a.link{padding:8px 10px;border-radius:12px}
.nav .cta{display:flex;gap:8px;margin-left:10px}
.btn{border:0;border-radius:999px;padding:10px 16px;font-weight:700;cursor:pointer}
.btn.cta{background:var(--cta);color:#fff}
.btn.grey{background:#e2e8f0}
.chip{padding:8px 12px;border-radius:14px;font-weight:700}
.chip.login{background:#e8edff;color:#1e40af}
.chip.member{background:#eaffef;color:#065f46}

/* HERO */
header.hero{background:#0f172a;color:#fff}
.hero .wrap{max-width:1100px;margin:auto;padding:28px 16px;display:grid;gap:10px;grid-template-columns:1fr auto;align-items:center}
.hero h1{margin:0;font-size:28px}
.hero p{margin:0;color:#cbd5e1}
.pill{padding:6px 10px;border-radius:999px;border:1px dashed var(--line);font-size:12px}
.pill.warn{border-color:#fbbf24;background:#fffbeb;color:#7c2d12}

/* Toolbar filtres */
.toolbar{
  position:sticky;top:62px;z-index:9;background:#fff;border:1px solid var(--line);
  border-radius:12px;padding:10px;display:flex;gap:10px;align-items:center;margin:14px 0;
  max-width:1100px;margin-left:auto;margin-right:auto
}
.toolbar select{padding:10px 12px;border-radius:12px;border:1px solid #cbd5e1;background:#fff}
.switch{display:flex;align-items:center;gap:8px;color:#0f172a;font-weight:600}

/* Cards */
.container{max-width:1100px;margin:24px auto;padding:0 14px}
.card{
  background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
  padding:16px;display:flex;flex-direction:column;gap:8px;
  box-shadow:0 6px 18px rgba(15,23,42,.05);margin-bottom:12px
}
.row{display:flex;justify-content:space-between;align-items:center;gap:10px}
.muted{color:var(--muted);font-size:14px}
.badge{background:#fff3c4;color:#7a5d00;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #ffe082}
.pill.full{border-color:#fecaca;background:#fff1f2;color:#7f1d1d}
.pill.warn{border-color:#fbbf24;background:#fffbeb;color:#7c2d12}
.priceTag{font-weight:800}
footer{padding:22px;text-align:center;color:#64748b;font-size:14px}

/* Mobile */
@media(max-width:900px){
  .nav ul{display:none}
  .hero .wrap{grid-template-columns:1fr}
}

/* Dialogs */
dialog::backdrop{background:rgba(0,0,0,.45)}
dialog.modal{border:0;border-radius:16px;padding:0;max-width:520px;width:92vw}
.modal-card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px}
.field{display:grid;gap:6px;margin:10px 0}
.field input{padding:12px;border-radius:12px;border:2px solid #cbd5e1;font:inherit}
</style>
</head>
<body>

<!-- NAV -->
<nav class="nav">
  <div class="inner">
    <a class="brand" href="index.html">
      <img src="images/logo_rsl.png" alt="RSL"><b>Romandie Scooter League</b>
    </a>
    <ul>
      <li><a class="link" href="formation.html">Formation RSL</a></li>
      <li><a class="link" href="disciplines.html">Disciplines</a></li>
      <li><a class="link" href="ou_rider.html">Où rider ?</a></li>
      <li><a class="link" href="evenements.html">Événements</a></li>
      <li><a class="link" href="contact.html">Contact</a></li>
    </ul>
    <div class="cta">
      <a class="btn grey" href="membres.html">Devenir membre</a>
      <button id="btnLogin" class="chip login">Login</button>
      <button id="btnLogout" class="chip member" style="display:none">Se déconnecter</button>
    </div>
  </div>
</nav>

<!-- HERO -->
<header class="hero">
  <div class="wrap">
    <div>
      <h1>Inscriptions aux cours 2026</h1>
      <p>Chaque samedi — tarifs automatiques (Public 30.–, Membre 20.–, Intermédiaire/Premium : gratuit selon quota/plan)</p>
    </div>
    <div class="pill warn">⚠️ Modification possible jusqu’à 14 jours avant la date</div>
  </div>
</header>

<!-- Toolbar filtres -->
<div class="toolbar">
  <select id="fMonth">
    <option value="">Tous les mois</option>
    <option value="0">Janvier</option><option value="1">Février</option>
    <option value="2">Mars</option><option value="3">Avril</option>
    <option value="4">Mai</option><option value="5">Juin</option>
    <option value="6">Juillet</option><option value="7">Août</option>
    <option value="8">Septembre</option><option value="9">Octobre</option>
    <option value="10">Novembre</option><option value="11">Décembre</option>
  </select>

  <select id="fLieu">
    <option value="">Tous les lieux</option>
    <option>Montreux</option><option>La Fièvre Genève</option>
    <option>Lausanne — Vidy</option><option>Bulle</option>
    <option>Yverdon</option><option>Martigny</option><option>Fribourg</option>
  </select>

  <label class="switch">
    <input type="checkbox" id="fOnlyAvail"><span>Seulement dispo</span>
  </label>
</div>

<!-- LISTE DES COURS -->
<main class="container">
  <div id="coursGrid">
    <div class="card"><b>Chargement…</b></div>
  </div>
</main>

<footer>© 2025 — Romandie Scooter League</footer>

<!-- LOGIN -->
<dialog id="dlgLogin" class="modal">
  <div class="modal-card">
    <h3>Connexion</h3>
    <p class="muted">Entre ton email, on t’envoie un lien magique.</p>
    <div class="field">
      <label>Email</label>
      <input id="loginEmail" type="email" placeholder="ton@email.ch"/>
    </div>
    <div class="row">
      <button class="btn grey" onclick="dlgLogin.close()">Fermer</button>
      <button id="btnSendMagic" class="btn cta">Recevoir le lien</button>
    </div>
  </div>
</dialog>

<!-- BOOK -->
<dialog id="dlgBook" class="modal">
  <div class="modal-card">
    <h3 id="bkTitle">Réserver</h3>
    <p id="bkMeta" class="muted"></p>
    <p id="bkNote" class="pill warn" style="display:none"></p>
    <div class="row">
      <button class="btn grey" onclick="dlgBook.close()">Annuler</button>
      <button id="btnConfirm" class="btn cta">Confirmer</button>
    </div>
  </div>
</dialog>

<script>
const SUPABASE_URL="https://jynxifufaauoxwzjapzq.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5bnhpZnVmYWF1b3h3emphcHpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzODI2NzcsImV4cCI6MjA3Njk1ODY3N30.vFPGhGakPIM3Xg5rn8_BrAXl6oJMJOssO780C9nXmr4";
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
const stripe=Stripe("pk_live_51SHkA04CyXBvyjQ00N7zRHQgtLlgeEcB7ohw0ISTC7ozijz1KFJoag2EVZN3JQs3aWAV1tPvM6Tx061sb9eyVMCi00j2Dgy94j");
const PRICE_PUBLIC="price_1SL40q4CyXBvyjQ0WchOzKhv";
const PRICE_MEMBER="price_1SL41X4CyXBvyj0Qg15rUxD4";
const FOURTEEN_DAYS=14*24*3600*1000;

/* AUTH */
const btnLogin=document.getElementById('btnLogin');
const btnLogout=document.getElementById('btnLogout');
const dlgLogin=document.getElementById('dlgLogin');
document.getElementById('btnSendMagic').onclick=async()=>{
  const email=document.getElementById('loginEmail').value.trim();
  if(!email)return alert("Entre un email.");
  const {error}=await sb.auth.signInWithOtp({email,options:{emailRedirectTo:location.href}});
  if(error)return alert(error.message);
  alert("Lien envoyé, vérifie ta boîte mail.");dlgLogin.close();
};
btnLogin.onclick=()=>dlgLogin.showModal();
btnLogout.onclick=async()=>{await sb.auth.signOut();updateAuthUI();};
async function updateAuthUI(){
  const {data:{user}}=await sb.auth.getUser();
  if(user){btnLogin.style.display='none';btnLogout.style.display='inline-block';}
  else{btnLogin.style.display='inline-block';btnLogout.style.display='none';}
}

/* COURSES */
async function fetchCourses(){
  const {data,error}=await sb.from('courses')
  .select('id,location,starts_at,capacity,enrollments(id)')
  .order('starts_at',{ascending:true});
  if(error)throw error;
  return data.map(c=>({...c,enrolled:(c.enrollments||[]).length,remaining:Math.max(0,c.capacity-(c.enrollments||[]).length)}));
}
function fmtDate(d){return new Date(d).toLocaleDateString('fr-CH',{weekday:'short',day:'2-digit',month:'2-digit',year:'numeric'});}
async function getCurrentMembership(uid){
  const {data,error}=await sb.from('current_membership')
  .select('user_id,plan,status,quota_total,quota_used,started_at,ends_at')
  .eq('user_id',uid).maybeSingle();
  if(error)throw error;return data;
}
function computePriceCHF(m){
  if(m&&m.plan==='premium'&&m.status==='active')return 0;
  if(m&&m.plan==='intermediaire'&&m.status==='active'&&(m.quota_total??0)>(m.quota_used??0))return 0;
  if(m&&m.status==='active')return 20;return 30;
}

/* RENDER grouped */
async function renderCourses(){
  const grid=document.getElementById('coursGrid');grid.innerHTML=`<div class="card"><b>Chargement…</b></div>`;
  const {data:{user}}=await sb.auth.getUser();
  const membership=user?await getCurrentMembership(user.id):null;
  try{
    let courses=await fetchCourses();
    const monthVal=document.getElementById('fMonth').value||"";
    const lieuVal=document.getElementById('fLieu').value||"";
    const onlyAvail=document.getElementById('fOnlyAvail').checked;
    courses=courses.filter(c=>{
      const d=new Date(c.starts_at);
      if(monthVal!==""&&d.getMonth()!==Number(monthVal))return false;
      if(lieuVal&&c.location!==lieuVal)return false;
      if(onlyAvail&&c.remaining<=0)return false;
      return true;
    });
    localStorage.setItem('rsl_courses_cache',JSON.stringify(courses));
    const groups={};for(const c of courses){const k=c.starts_at.slice(0,10);(groups[k]||=[]).push(c);}
    grid.innerHTML="";const now=Date.now();
    Object.keys(groups).sort().forEach(k=>{
      const day=new Date(k);
      const title=day.toLocaleDateString('fr-CH',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
      const section=document.createElement('section');
      section.className="card";
      section.innerHTML=`<h3 style='margin:0 0 6px'>${title}</h3>`;
      const list=document.createElement('div');list.style.display='grid';list.style.gap='10px';
      groups[k].sort((a,b)=>a.location.localeCompare(b.location)).forEach(c=>{
        const soonLocked=(new Date(c.starts_at).getTime()-now)<FOURTEEN_DAYS;
        const full=c.remaining<=0;
        const disabled=full||soonLocked;
        const price=computePriceCHF(membership);
        const label=full?"Complet":(soonLocked?"Verrouillé (-14j)":(price===0?"Gratuit":price+".–"));
        const row=document.createElement('div');row.className="row";
        row.innerHTML=`
          <div><b>${c.location}</b>
          <div class="muted">${c.remaining} place${c.remaining>1?"s":""} restantes</div></div>
          <button class="btn cta" ${disabled?"disabled":""}>S’inscrire · ${label}</button>`;
        const btn=row.querySelector('button');btn.addEventListener('click',()=>openBooking(c));
        list.appendChild(row);
      });
      section.appendChild(list);grid.appendChild(section);
    });
    if(Object.keys(groups).length===0){grid.innerHTML=`<div class="card">Aucun cours pour ces filtres.</div>`;}
    ['fMonth','fLieu','fOnlyAvail'].forEach(id=>{
      const el=document.getElementById(id);
      if(el&&!el.dataset.bound){el.addEventListener('change',renderCourses);el.dataset.bound="1";}
    });
  }catch(err){
    console.warn("Erreur offline",err);
    const cache=localStorage.getItem('rsl_courses_cache');
    if(cache){grid.innerHTML=`<div class='card'>Mode hors-ligne.</div>`;}
    else{grid.innerHTML=`<div class='card'>Erreur de chargement.</div>`;}
  }
}

/* BOOKING */
const dlgBook=document.getElementById('dlgBook');
const bkTitle=document.getElementById('bkTitle');
const bkMeta=document.getElementById('bkMeta');
const bkNote=document.getElementById('bkNote');
const btnConfirm=document.getElementById('btnConfirm');
let pendingCourse=null;
async function openBooking(course){
  const {data:{user}}=await sb.auth.getUser();
  if(!user){dlgLogin.showModal();return;}
  pendingCourse=course;
  const m=await getCurrentMembership(user.id);
  const price=computePriceCHF(m);
  bkTitle.textContent=`Réserver — ${course.location}`;
  bkMeta.innerHTML=`${fmtDate(course.starts_at)} · ${course.remaining} places · Tarif: <b>${price===0?'Gratuit':price+'.–'}</b>`;
  bkNote.style.display='block';
  bkNote.textContent='Modification possible jusqu’à 14 jours avant la date.';
  btnConfirm.onclick=()=>confirmBooking(price);
  dlgBook.showModal();
}