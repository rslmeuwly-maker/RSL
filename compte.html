<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mon compte ‚Äî Romandie Scooter League</title>

  <!-- Fonts + Styles globaux -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/common.css"/>

  <!-- Supabase + scripts du site -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script defer src="js/env.js"></script>
  <script defer src="js/auth.js"></script>
  <script defer src="js/site.js"></script>

  <style>
    :root{
      --rsl-bg: #020617;
      --rsl-fg: #e5e7eb;
      --rsl-muted: #9ca3af;
      --rsl-card: rgba(15,23,42,.96);
      --rsl-card-soft: rgba(15,23,42,.9);
      --rsl-border: rgba(148,163,184,.45);
      --rsl-accent: #22c55e;
      --rsl-accent-soft: rgba(34,197,94,.14);
    }

    body.theme-light{
      --rsl-bg: #f3f4f6;
      --rsl-fg: #0f172a;
      --rsl-muted: #6b7280;
      --rsl-card: #ffffff;
      --rsl-card-soft: #f9fafb;
      --rsl-border: rgba(148,163,184,.35);
      --rsl-accent: #16a34a;
      --rsl-accent-soft: rgba(22,163,74,.12);
    }

    html, body{
      height:100%;
      margin:0;
      font-family:"Outfit",system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:transparent !important;
      color:var(--rsl-fg);
      display:flex;
      flex-direction:column;
      overflow-x:hidden;
    }
    main{
      flex:1;
      position:relative;
      z-index:10;
    }

    /* ======= Vid√©o de fond ======= */
    .site-bg-video{
      position:fixed;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      z-index:-2;
      background:#000;
    }
    .site-bg-dim{
      position:fixed;
      inset:0;
      z-index:-1;
      background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,.9));
      transition:background .25s ease;
    }
    body.theme-light .site-bg-dim{
      background:linear-gradient(180deg,rgba(249,250,251,.9),rgba(15,23,42,.85));
    }

    /* ======= NAVBAR (copie index) ======= */
    nav.nav{
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(10px);
      position: sticky;
      top:0;
      z-index:100;
      transition:background .25s ease, border-color .25s ease, box-shadow .25s ease;
      border-bottom:1px solid rgba(15,23,42,.8);
    }
    nav.nav .container{ max-width:1320px; margin:0 auto; padding:10px 18px; }
    nav.nav .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }

    body.theme-light nav.nav{
      background:rgba(248,250,252,.96);
      border-bottom:1px solid rgba(148,163,184,.5);
      box-shadow:0 10px 30px rgba(15,23,42,.06);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      color:inherit;
      text-decoration:none;
    }
    .brand img{
      height:42px;
      border-radius:10px;
      display:block;
      background:#fff;
      padding:3px;
      box-shadow:0 10px 28px rgba(0,0,0,.35);
    }
    .brand span{
      font-weight:800;
      letter-spacing:.2px;
      font-size:16px;
      white-space:nowrap;
    }

    nav.nav ul{
      display:flex;
      align-items:center;
      gap:20px;
    }
    nav.nav ul li{list-style:none;}
    nav.nav ul li a{
      font-weight:600;
      color:var(--rsl-fg);
      font-size:15px;
      letter-spacing:.02em;
      white-space:nowrap;
      text-decoration:none;
      opacity:.9;
      transition:.2s ease;
    }
    nav.nav ul li a:hover{
      color:var(--rsl-accent);
      opacity:1;
    }

    .cta{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .btn{
      border-radius:999px;
      padding:8px 14px;
      font-size:14px;
      font-weight:700;
      border:1px solid rgba(148,163,184,.5);
      text-decoration:none;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:rgba(15,23,42,.9);
      color:#f9fafb;
      transition:.2s ease;
    }
    body.theme-light .btn{
      background:#0f172a;
      color:#f9fafb;
      border-color:#0f172a;
    }
    .btn.green{
      background:var(--rsl-accent);
      color:#052e16;
      border-color:transparent;
      box-shadow:0 10px 26px rgba(22,163,74,.45);
    }
    .btn:hover{
      transform:translateY(-1px);
      filter:brightness(1.05);
    }

    /* Avatar dans la navbar */
    .nav-avatar{
      width:34px;
      height:34px;
      border-radius:999px;
      object-fit:cover;
      border:2px solid var(--rsl-accent);
      box-shadow:0 0 10px rgba(34,197,94,.5);
    }

    /* Toggle th√®me */
    .theme-toggle{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      width:34px;
      height:34px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:17px;
      cursor:pointer;
      padding:0;
      transition:.2s ease;
    }
    .theme-toggle:hover{
      transform:translateY(-1px);
      filter:brightness(1.08);
    }
    body.theme-light .theme-toggle{
      background:#ffffff;
      color:#0f172a;
      border-color:rgba(148,163,184,.7);
    }

    #menuBtn{
      display:none;
      align-items:center;
      justify-content:center;
      padding:7px 10px;
      font-size:18px;
      line-height:1;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.4);
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      cursor:pointer;
      transition:.2s ease;
    }
    #menuBtn:hover { filter:brightness(1.1); }
    body.theme-light #menuBtn{
      background:#0f172a;
      color:#f9fafb;
      border-color:#0f172a;
    }

    .container{ max-width:1200px; margin:0 auto; padding:0 16px; }

    /* MENU MOBILE */
    .mobile-sheet{
      position:fixed;
      inset:0;
      display:none;
      z-index:120;
    }
    .mobile-sheet.open{ display:block; }
    .mobile-dim{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.5);
    }
    .mobile-panel{
      position:absolute;
      top:0;
      right:0;
      height:100%;
      width:82vw;
      max-width:360px;
      background:var(--rsl-card);
      padding:20px 18px 24px;
      display:flex;
      flex-direction:column;
      gap:10px;
      border-left:1px solid rgba(255,255,255,.08);
      box-shadow:-12px 0 30px rgba(0,0,0,.5);
    }
    .mobile-panel a{
      color:var(--rsl-fg);
      text-decoration:none;
      font-weight:600;
      padding:6px 0;
      font-size:14px;
    }

    /* FOOTER */
    .footer-mini .copy{
      text-align:center;
      color:var(--rsl-muted);
      font-size:13px;
      padding:20px 0 24px;
      margin:0;
      border-top:1px solid rgba(15,23,42,.7);
      background:rgba(15,23,42,.85);
    }
    body.theme-light .footer-mini .copy{
      background:rgba(248,250,252,.96);
      border-top-color:rgba(148,163,184,.5);
    }

    @media (max-width:990px){
      nav.nav ul{ display:none !important; }
      #btnCart,
      .btn.green{
        display:none !important;
      }
      #menuBtn{ display:inline-flex; }
    }

    /* ======= CONTENU COMPTE ======= */
    .wrap{
      max-width:1120px;
      margin:0 auto;
      padding:28px 18px 60px;
      display:flex;
      flex-direction:column;
      gap:24px;
      box-sizing:border-box;
    }
    @media(max-width:990px){
      .wrap{
        padding:20px 14px 50px;
      }
    }

    h1{
      font-size:28px;
      font-weight:800;
      margin:0 0 6px;
      letter-spacing:.02em;
      color:var(--rsl-fg);
    }
    p.sub{
      color:var(--rsl-muted);
      margin:0 0 20px;
      font-size:14px;
    }

    .top-grid{
      display:grid;
      grid-template-columns:minmax(0,1.2fr) minmax(0,1fr);
      gap:18px;
    }
    @media(max-width:900px){
      .top-grid{
        grid-template-columns:1fr;
      }
    }

    .card{
      background:var(--rsl-card);
      border:1px solid var(--rsl-border);
      border-radius:18px;
      box-shadow:0 18px 40px rgba(0,0,0,.75);
      padding:16px 16px 14px;
    }
    body.theme-light .card{
      box-shadow:0 18px 40px rgba(15,23,42,.12);
    }
    .card h2{
      font-size:16px;
      font-weight:700;
      margin:0 0 4px;
      color:var(--rsl-fg);
    }
    .card p.small{
      color:var(--rsl-muted);
      font-size:13px;
      margin:0 0 8px;
    }

    .profile-row{
      display:flex;
      align-items:flex-start;
      gap:12px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .profile-infos{
      font-size:13px;
      color:var(--rsl-fg);
      flex:1;
      min-width:200px;
    }
    .profile-infos div{
      margin-bottom:2px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius:999px;
      font-size:11px;
      background:rgba(15,23,42,1);
      border:1px solid rgba(148,163,184,.6);
      color:#e5e7eb;
      margin-top:6px;
    }
    .pill.green{
      border-color:rgba(34,197,94,.9);
      color:#bbf7d0;
      background:rgba(22,163,74,.16);
    }
    .pill.red{
      border-color:rgba(248,113,113,.9);
      color:#fecaca;
      background:rgba(127,29,29,.7);
    }
    .pill.orange{
      border-color:rgba(251,191,36,.9);
      color:#fef3c7;
      background:rgba(146,64,14,.7);
    }

    /* Formulaire profil */
    .profile-form{
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-width:420px;
    }
    .profile-form label{
      font-size:12px;
      color:var(--rsl-muted);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .profile-form input{
      border-radius:10px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      padding:7px 9px;
      font-size:13px;
      outline:none;
    }
    body.theme-light .profile-form input{
      background:#ffffff;
      color:#0f172a;
    }
    .profile-form input:focus{
      border-color:var(--rsl-accent);
      box-shadow:0 0 0 1px rgba(34,197,94,.55);
    }
    .profile-actions{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:8px;
    }
    .profile-btn{
      border-radius:999px;
      padding:7px 12px;
      font-size:12px;
      font-weight:600;
      border:1px solid rgba(148,163,184,.7);
      background:rgba(15,23,42,.95);
      color:#e5e7eb;
      cursor:pointer;
    }
    body.theme-light .profile-btn{
      background:#0f172a;
      color:#f9fafb;
      border-color:#0f172a;
    }
    .profile-btn.primary{
      background:linear-gradient(135deg,#22c55e,#16a34a);
      border-color:transparent;
      color:#022c22;
      box-shadow:0 8px 20px rgba(22,163,74,.6);
    }
    .profile-status{
      font-size:12px;
      color:var(--rsl-muted);
      margin-top:4px;
    }
    .profile-status.ok{ color:#bbf7d0; }
    .profile-status.err{ color:#fecaca; }

    .membership-main{
      font-size:13px;
      color:var(--rsl-fg);
    }
    .membership-main div{ margin-bottom:2px; }

    .courses-grid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:18px;
    }
    @media(max-width:1100px){
      .courses-grid{ grid-template-columns:repeat(2, minmax(0,1fr)); }
    }
    @media(max-width:780px){
      .courses-grid{ grid-template-columns:1fr; }
    }

    .course-list{
      margin-top:10px;
      max-height:420px;
      overflow:auto;
      padding-right:4px;
    }
    .course-item{
      border-radius:12px;
      border:1px solid rgba(148,163,184,.4);
      padding:7px 9px;
      margin-bottom:7px;
      font-size:12px;
      background:rgba(15,23,42,1);
    }
    body.theme-light .course-item{ background:#ffffff; }
    .course-item-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:6px;
      margin-bottom:3px;
    }
    .course-spot{ font-weight:700; font-size:13px; }
    .course-date{
      font-size:11px;
      color:var(--rsl-muted);
      white-space:nowrap;
    }
    .course-title{ font-size:12px; margin-bottom:3px; }
    .course-foot{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-top:3px;
    }
    .course-price{ font-weight:600; font-size:12px; }
    .text-muted{ color:var(--rsl-muted); font-size:12px; }
  </style>
</head>

<body>
  <!-- VID√âO DE FOND -->
  <video class="site-bg-video" autoplay muted loop playsinline id="rslBg"></video>
  <div class="site-bg-dim" aria-hidden="true"></div>

  <!-- NAV -->
  <nav class="nav">
    <div class="container">
      <div class="row">
        <a class="brand" href="index.html">
          <img src="images/logo_rsl.png" alt="Logo RSL"/>
          <span>RSL ‚Äî Romandie Scooter League</span>
        </a>

        <ul>
          <li><a href="cours.html">Cours</a></li>
          <li><a href="formation.html">Formation RSL</a></li>
          <li><a href="ou_rider.html">O√π rider ?</a></li>
          <li><a href="evenements.html">√âv√©nements</a></li>
          <li><a href="disciplines.html">Disciplines</a></li>
          <li><a href="shop-rsl.html">Shop</a></li>
          <li><a href="comite.html">Comit√©</a></li>
          <li><a href="contact.html">Contact</a></li>
        </ul>

        <div class="cta">
          <button id="themeToggle" class="theme-toggle" aria-label="Changer le th√®me">üåô</button>

          <a class="btn" id="btnLogin" href="access.html">Login</a>
          <a class="btn" id="btnAccount" href="compte.html" style="display:none">Mon compte</a>
          <button class="btn" id="btnLogout" style="display:none;">D√©connexion</button>

          <a href="compte.html">
            <img id="navAvatar" class="nav-avatar" src="images/logo_rsl.png" alt="Avatar" style="display:none;">
          </a>

          <a class="btn" id="btnCart" href="panier/panier.html">Panier</a>
          <a class="btn green" href="membres.html">Devenir membre</a>
          <button id="menuBtn">‚ò∞</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- MENU MOBILE -->
  <div class="mobile-sheet" id="mobileMenu">
    <div class="mobile-dim"></div>
    <nav class="mobile-panel">
      <a href="index.html">Accueil</a>
      <a href="cours.html">Cours</a>
      <a href="membres.html">Devenir membre</a>
      <a href="formation.html">Formation RSL</a>
      <a href="disciplines.html">Disciplines</a>
      <a href="ou_rider.html">O√π rider ?</a>
      <a href="evenements.html">√âv√©nements</a>
      <a href="game.html">Games</a>
      <a href="shop-rsl.html">Shop</a>
      <a href="comite.html">Comit√©</a>
      <a href="contact.html">Contact</a>
      <a href="conditions.html">Conditions g√©n√©rales</a>
      <a href="compte.html" aria-current="page">Mon compte</a>
      <a href="coach.html" class="coach-link">üë®‚Äçüè´ Je suis coach</a>
      <a id="mobileLogout" style="display:none; color:#f87171; font-weight:700; cursor:pointer;">D√©connexion</a>
    </nav>
  </div>

  <!-- CONTENU -->
  <main>
    <div class="wrap">
      <header>
        <h1>Mon compte</h1>
        <p class="sub">Retrouve ton profil, ton abonnement et tous tes cours enregistr√©s (r√©serv√©s, pay√©s ou inclus dans ton abo).</p>
      </header>

      <div class="top-grid">
        <!-- Infos profil -->
        <section class="card">
          <h2>Mes infos</h2>
          <p class="small">Renseignements de base li√©s √† ton compte RSL.</p>

          <div class="profile-row">
            <img id="profileAvatar" class="nav-avatar" src="images/logo_rsl.png" alt="Avatar">

            <div class="profile-infos">
              <div id="profileName">Non connect√©</div>
              <div id="profileEmail" class="text-muted">‚Äî</div>
              <div id="profilePhone" class="text-muted">T√©l√©phone : ‚Äî</div>
              <span id="loginHint" class="pill orange" style="display:none;">
                ‚ö†Ô∏è Connecte-toi pour voir et modifier ton profil
              </span>

              <form id="profileForm" class="profile-form">
                <label>
                  Pseudo / Rider name
                  <input id="fieldPseudo" type="text" placeholder="Ex: JF_Rider">
                </label>
                <label>
                  Pr√©nom du rider
                  <input id="fieldRiderFirst" type="text" placeholder="Pr√©nom du rider">
                </label>
                <label>
                  Nom du rider
                  <input id="fieldRiderLast" type="text" placeholder="Nom du rider">
                </label>
                <label>
                  T√©l√©phone du parent
                  <input id="fieldParentPhone" type="tel" placeholder="+41 ...">
                </label>

                <div class="profile-actions">
                  <button type="button" id="btnSaveProfile" class="profile-btn primary">Enregistrer mes infos</button>
                  <button type="button" id="btnChangeAvatar" class="profile-btn">Changer la photo de profil</button>
                  <input type="file" id="avatarInput" accept="image/*" style="display:none;">
                </div>

                <div id="profileSaveStatus" class="profile-status"></div>
              </form>
            </div>
          </div>
        </section>

        <!-- Abonnement -->
        <section class="card">
          <h2>Mon abonnement RSL</h2>
          <p class="small">Abo en cours et cours inclus automatiquement.</p>
          <div id="membershipBox" class="membership-main text-muted">Chargement de l‚Äôabonnement...</div>
        </section>
      </div>

      <!-- Cours -->
      <section class="card">
        <h2>Mes cours</h2>
        <p class="small">Tous les cours enregistr√©s via le panier s‚Äôaffichent ici automatiquement.</p>

        <div class="courses-grid">
          <div>
            <div class="pill green">‚úÖ Inclus dans ton abonnement</div>
            <div id="membershipCourses" class="course-list text-muted">Chargement...</div>
          </div>

          <div>
            <div class="pill">üí≥ R√©serv√©s et pay√©s</div>
            <div id="paidCourses" class="course-list text-muted">Chargement...</div>
          </div>

          <div>
            <div class="pill red">‚è≥ R√©serv√©s, en attente de paiement</div>
            <div id="pendingCourses" class="course-list text-muted">Chargement...</div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer class="footer-mini">
    <p class="copy">¬© 2026 ‚Äî RSL Romandie Scooter League. Tous droits r√©serv√©s.</p>
  </footer>

  <script>
    // ==== Th√®me (copi√© index) ====
    (function(){
      const STORAGE_KEY = 'rsl-theme';
      const body = document.body;
      const btn = document.getElementById('themeToggle');

      function applyTheme(theme){
        if(theme === 'light'){
          body.classList.add('theme-light');
          if(btn) btn.textContent = '‚òÄÔ∏è';
        }else{
          body.classList.remove('theme-light');
          if(btn) btn.textContent = 'üåô';
        }
      }

      let saved = null;
      try{ saved = localStorage.getItem(STORAGE_KEY); }catch(e){}
      if(!saved){
        const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
        saved = prefersLight ? 'light' : 'dark';
      }
      applyTheme(saved);

      if(btn){
        btn.addEventListener('click', ()=>{
          const current = body.classList.contains('theme-light') ? 'light' : 'dark';
          const next = current === 'light' ? 'dark' : 'light';
          applyTheme(next);
          try{ localStorage.setItem(STORAGE_KEY, next); }catch(e){}
        });
      }
    })();

    // ==== Vid√©o de fond (copi√© index) ====
    (function(){
      const vids = [
        "https://jynxifufaauoxwzjapzq.supabase.co/storage/v1/object/public/videos_rsl/trottvideo1.mp4",
        "https://jynxifufaauoxwzjapzq.supabase.co/storage/v1/object/public/videos_rsl/trottvideo2.mp4"
      ];
      const pick = vids[Math.floor(Math.random()*vids.length)];
      const v = document.getElementById('rslBg');
      if(!v) return;
      const s = document.createElement('source');
      s.src = pick;
      s.type = 'video/mp4';
      v.appendChild(s);
      const start = () => {
        try{
          v.playbackRate = 0.6;
          const p = v.play();
          if(p && p.catch) p.catch(()=>{});
        }catch(e){}
      };
      start();
      document.addEventListener('visibilitychange', () => {
        if(document.hidden) v.pause(); else start();
      });
    })();

    // ==== Menu mobile (copi√© index) ====
    (function(){
      const menuBtn=document.getElementById('menuBtn');
      const mobile=document.getElementById('mobileMenu');
      if(!menuBtn || !mobile) return;
      menuBtn.addEventListener('click',e=>{
        e.stopPropagation();
        mobile.classList.add('open');
        mobile.setAttribute('aria-hidden','false');
      });
      mobile.querySelector('.mobile-dim')?.addEventListener('click',()=>{
        mobile.classList.remove('open');
        mobile.setAttribute('aria-hidden','true');
      });
      document.addEventListener('keydown',e=>{
        if(e.key==='Escape'){
          mobile.classList.remove('open');
          mobile.setAttribute('aria-hidden','true');
        }
      });
    })();

    // ==== Supabase / mappings profils (ADAPT√â √Ä TA TABLE) ====
    const AVATAR_BUCKET = "avatars";
    const PROFILE_TABLE = "profiles";
    const AVATAR_TABLE  = "rsl_avatars";

    // ‚úÖ Ta table profiles utilise "id" (uuid) = auth.uid()
    const PROFILE_PK = "id";
    const COL_PSEUDO = "pseudo";
    const COL_FULLNAME = "full_name";
    const COL_RIDERNAME = "rider_name";
    const COL_PHONE = "phone";

    // ‚úÖ Un seul client (env.js doit d√©finir window.supabaseClient id√©alement)
    let sb = null;
    if (window.supabaseClient) {
      sb = window.supabaseClient;
    } else if (window.supabase && window.supabase.createClient && window.env?.SUPABASE_URL && window.env?.SUPABASE_ANON) {
      sb = window.supabase.createClient(window.env.SUPABASE_URL, window.env.SUPABASE_ANON);
      window.supabaseClient = sb;
    } else if (window.supabase && window.supabase.createClient) {
      // fallback (au cas o√π env.js n'est pas pr√™t)
      const SUPABASE_URL = "https://jynxifufaauoxwzjapzq.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5bnhpZnVmYWF1b3h3emphcHpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzODI2NzcsImV4cCI6MjA3Njk1ODY3N30.vFPGhGakPIM3Xg5rn8_BrAXl6oJMJOssO780C9nXmr4";
      sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      window.supabaseClient = sb;
    }

    let currentUser = null;
    let currentMembership = null;

    // ==== Avatar nav / profil depuis localStorage ====
    const navAvatar = document.getElementById('navAvatar');
    const profileAvatar = document.getElementById('profileAvatar');

    function getAvatarLS(){
      try{ return localStorage.getItem('rsl_avatar') || null; }catch(e){ return null; }
    }
    function setAvatarLS(url){
      try{
        if(url) localStorage.setItem('rsl_avatar', url);
        else localStorage.removeItem('rsl_avatar');
      }catch(e){}
    }
    function applyAvatar(){
      const stored = getAvatarLS();
      const src = stored || "images/logo_rsl.png";
      if(navAvatar){
        navAvatar.src = src;
        navAvatar.style.display = stored ? "inline-block" : "none";
      }
      if(profileAvatar) profileAvatar.src = src;
    }

    function getProfileLS(){
      try{ return JSON.parse(localStorage.getItem('rsl_profile')||'{}'); }
      catch(e){ return {}; }
    }
    function setProfileLS(p){
      try{ localStorage.setItem('rsl_profile', JSON.stringify(p || {})); }catch(e){}
    }

    // ==== DOM profil / abo / cours ====
    const profileName = document.getElementById("profileName");
    const profileEmail = document.getElementById("profileEmail");
    const profilePhone = document.getElementById("profilePhone");
    const loginHint = document.getElementById("loginHint");

    const fieldPseudo = document.getElementById("fieldPseudo");
    const fieldRiderFirst = document.getElementById("fieldRiderFirst");
    const fieldRiderLast = document.getElementById("fieldRiderLast");
    const fieldParentPhone = document.getElementById("fieldParentPhone");
    const btnSaveProfile = document.getElementById("btnSaveProfile");
    const btnChangeAvatar = document.getElementById("btnChangeAvatar");
    const avatarInput = document.getElementById("avatarInput");
    const profileSaveStatus = document.getElementById("profileSaveStatus");

    const membershipBox = document.getElementById("membershipBox");
    const membershipCoursesEl = document.getElementById("membershipCourses");
    const paidCoursesEl = document.getElementById("paidCourses");
    const pendingCoursesEl = document.getElementById("pendingCourses");

    const btnLogout = document.getElementById("btnLogout");
    const btnAccount = document.getElementById("btnAccount");
    const mobileLogout = document.getElementById("mobileLogout");
    const btnLoginEl = document.getElementById("btnLogin");

    // ==== Abonnement (inchang√©) ====
    async function fetchMembership(sbClient, userId){
      if(!sbClient || !sbClient.from || !userId) return null;
      try{
        const { data, error } = await sbClient
          .from('rsl_memberships')
          .select('membership_code, expires_at, is_paid, created_at')
          .eq('user_id', userId)
          .eq('is_paid', true)
          .order('created_at', { ascending:false })
          .limit(1)
          .maybeSingle();

        if(error || !data) return null;

        if(data.expires_at){
          const d = new Date(data.expires_at);
          if(!isNaN(d.getTime()) && d < new Date()) return null;
        }
        return data;
      }catch(e){
        console.warn("Erreur fetch abo:", e);
        return null;
      }
    }

    function formatDate(dStr){
      if(!dStr) return "";
      const d = new Date(dStr);
      if(isNaN(d.getTime())) return dStr;
      const day = String(d.getDate()).padStart(2,"0");
      const month = String(d.getMonth()+1).padStart(2,"0");
      const year = d.getFullYear();
      return `${day}.${month}.${year}`;
    }

    function renderMembershipBox(m){
      if(!m){
        membershipBox.innerHTML = `
          <div>Pas d‚Äôabonnement actif actuellement.</div>
          <div class="text-muted" style="margin-top:4px;">Tu peux prendre un abonnement directement sur la page <a href="membres.html" style="color:#a5b4fc; text-decoration:underline;">Devenir membre</a>.</div>
        `;
        return;
      }

      const code = (m.membership_code || "").toUpperCase();
      const exp  = m.expires_at ? formatDate(m.expires_at) : "‚Äî";
      const start = m.created_at ? formatDate(m.created_at) : "‚Äî";

      let infoTxt = "";
      if(code.toLowerCase() === "premium"){
        infoTxt = "Cours RSL illimit√©s sur la p√©riode de ton abonnement.";
      }else if(code.toLowerCase() === "progression"){
        infoTxt = "15 cours de progression inclus puis tarifs r√©duits sur les suivants.";
      }else{
        infoTxt = "Tarif r√©duit sur les cours RSL pendant la dur√©e de ton abonnement.";
      }

      membershipBox.innerHTML = `
        <div><strong>Type :</strong> ${code}</div>
        <div><strong>D√©but :</strong> ${start}</div>
        <div><strong>Valide jusqu‚Äôau :</strong> ${exp}</div>
        <div class="text-muted" style="margin-top:6px;">${infoTxt}</div>
      `;
    }

    // ==== Charger les cours (inchang√©) ====
    async function loadCourses(){
      if(!currentUser || !sb || !sb.from){
        membershipCoursesEl.textContent = "Connecte-toi pour voir tes cours.";
        paidCoursesEl.textContent = "Connecte-toi pour voir tes cours.";
        pendingCoursesEl.textContent = "Connecte-toi pour voir tes cours.";
        return;
      }

      membershipCoursesEl.textContent = "Chargement...";
      paidCoursesEl.textContent = "Chargement...";
      pendingCoursesEl.textContent = "Chargement...";

      try{
        const { data, error } = await sb
          .from("rsl_course_registrations")
          .select(`
            id, date, date_label,
            spot_name, title, price_chf, is_paid,
            course_spot_name, course_title, course_price_chf, course_is_paid,
            membership_included, payment_status, twint_ref, created_at
          `)
          .eq("user_id", currentUser.id)
          .order("date", { ascending:true });

        if(error){
          console.warn("Erreur fetch cours:", error);
          membershipCoursesEl.textContent = "Impossible de charger les cours.";
          paidCoursesEl.textContent = "Impossible de charger les cours.";
          pendingCoursesEl.textContent = "Impossible de charger les cours.";
          return;
        }

        const rows = data || [];
        const membershipCourses = [];
        const paidCourses = [];
        const pendingCourses = [];

        rows.forEach(r=>{
          const isIncluded = r.membership_included === true;
          const isPaidFlag =
            r.is_paid === true ||
            r.course_is_paid === true ||
            (r.payment_status && r.payment_status.toLowerCase().includes("pay"));

          const spot = r.course_spot_name || r.spot_name || "Lieu inconnu";
          const title = r.course_title || r.title || "";
          const price = (r.course_price_chf ?? r.price_chf ?? 0);
          const dateLabel = r.date_label || (r.date ? formatDate(r.date) : "Date √† confirmer");

          const item = { id:r.id, spot, title, price, membership_included:isIncluded, isPaid:isPaidFlag, payment_status:r.payment_status||"", dateLabel };

          if(isIncluded) membershipCourses.push(item);
          if(!isIncluded && isPaidFlag) paidCourses.push(item);
          if(!isIncluded && !isPaidFlag) pendingCourses.push(item);
        });

        function renderList(targetEl, list, emptyText){
          if(!list.length){
            targetEl.innerHTML = `<p class="text-muted">${emptyText}</p>`;
            return;
          }
          targetEl.innerHTML = list.map(c=>{
            let statusText = "";
            if(c.membership_included){
              statusText = "Inclus dans ton abo";
            }else if(c.isPaid){
              statusText = c.payment_status && c.payment_status.toLowerCase().includes("twint")
                ? "Pay√© (TWINT / caisse)"
                : "Pay√©";
            }else{
              statusText = "√Ä payer (Stripe / caisse)";
            }

            const priceLabel = c.price ? `CHF ${c.price}.‚Äì` : "CHF 0.‚Äì";

            return `
              <div class="course-item">
                <div class="course-item-header">
                  <div class="course-spot">${c.spot}</div>
                  <div class="course-date">${c.dateLabel}</div>
                </div>
                ${c.title ? `<div class="course-title">${c.title}</div>` : ""}
                <div class="course-foot">
                  <div class="course-price">${priceLabel}</div>
                  <div class="text-muted">${statusText}</div>
                </div>
              </div>
            `;
          }).join("");
        }

        renderList(membershipCoursesEl, membershipCourses, "Aucun cours inclus dans ton abonnement pour l‚Äôinstant.");
        renderList(paidCoursesEl, paidCourses, "Aucun cours payant enregistr√© pour l‚Äôinstant.");
        renderList(pendingCoursesEl, pendingCourses, "Aucun cours en attente de paiement pour l‚Äôinstant.");
      }catch(e){
        console.warn("Exception loadCourses:", e);
        membershipCoursesEl.textContent = "Erreur lors du chargement des cours.";
        paidCoursesEl.textContent = "Erreur lors du chargement des cours.";
        pendingCoursesEl.textContent = "Erreur lors du chargement des cours.";
      }
    }

    // ==== Gestion profil (ADAPT√â) ====
    function setProfileStatus(msg, type){
      if(!profileSaveStatus) return;
      profileSaveStatus.textContent = msg || "";
      profileSaveStatus.classList.remove("ok","err");
      if(type) profileSaveStatus.classList.add(type);
    }

    function hydrateProfileFormFromObj(p){
      if(!p) return;
      if(fieldPseudo) fieldPseudo.value = p.pseudo || "";
      if(fieldRiderFirst) fieldRiderFirst.value = p.riderFirst || "";
      if(fieldRiderLast) fieldRiderLast.value = p.riderLast || "";
      if(fieldParentPhone) fieldParentPhone.value = p.parentPhone || "";
    }

    function updateProfileTextsFromObj(p){
      const pseudo = (p?.pseudo || "").trim();
      const first  = (p?.riderFirst || "").trim();   // ‚Üê full_name
      const last   = (p?.riderLast  || "").trim();   // ‚Üê rider_name
      const phone  = (p?.parentPhone || "").trim();  // ‚Üê phone

      let displayName = pseudo || `${first} ${last}`.trim();

      if(!displayName && currentUser){
        displayName =
          (currentUser.user_metadata?.full_name || currentUser.user_metadata?.name || "").trim()
          || (currentUser.email || "").trim()
          || "Connect√©";
      }

      if(profileName) profileName.textContent = displayName || "Connect√©";
      if(profileEmail && currentUser?.email) profileEmail.textContent = currentUser.email;

      if(profilePhone){
        profilePhone.textContent = "T√©l√©phone : " + (phone || "‚Äî");
      }
    }

    // ‚úÖ LOAD: profiles.id = auth.uid()
    async function loadProfileFromSupabase(userId){
      if(!sb || !sb.from || !userId) return;

      try{
        const { data, error } = await sb
          .from(PROFILE_TABLE)
          .select(`${COL_PSEUDO}, ${COL_FULLNAME}, ${COL_RIDERNAME}, ${COL_PHONE}`)
          .eq(PROFILE_PK, userId)
          .maybeSingle();

        if(error){
          console.warn("Erreur load profile:", error);
        }

        const local = getProfileLS();

        const merged = {
          pseudo: data?.[COL_PSEUDO] ?? local.pseudo,
          riderFirst: data?.[COL_FULLNAME] ?? local.riderFirst,
          riderLast: data?.[COL_RIDERNAME] ?? local.riderLast,
          parentPhone: data?.[COL_PHONE] ?? local.parentPhone
        };

        hydrateProfileFormFromObj(merged);
        updateProfileTextsFromObj(merged);
        setProfileLS(merged);

        applyAvatar();
      }catch(e){
        console.warn("Exception load profile:", e);
      }
    }

    // ==== Avatar depuis rsl_avatars (inchang√©) ====
    async function loadAvatarFromDb(userId){
      if(!sb || !sb.from || !userId) return;
      try{
        const { data, error } = await sb
          .from(AVATAR_TABLE)
          .select("avatar_url")
          .eq("user_id", userId)
          .maybeSingle();

        if(error){
          console.warn("Erreur load avatar (rsl_avatars):", error);
          return;
        }
        if(data && data.avatar_url){
          const url = data.avatar_url;
          if(navAvatar){
            navAvatar.src = url;
            navAvatar.style.display = "inline-block";
          }
          if(profileAvatar) profileAvatar.src = url;
          setAvatarLS(url);
        }
      }catch(e){
        console.warn("Exception loadAvatarFromDb:", e);
      }
    }

    // ‚úÖ SAVE: upsert sur profiles.id + colonnes existantes (pseudo/full_name/rider_name/phone)
    async function saveProfileToSupabase(){
      if(!currentUser || !sb || !sb.from){
        setProfileStatus("Tu dois √™tre connect√© pour modifier ton profil.", "err");
        return;
      }

      const pseudo = fieldPseudo?.value.trim() || "";
      const riderFirst = fieldRiderFirst?.value.trim() || "";
      const riderLast = fieldRiderLast?.value.trim() || "";
      const parentPhone = fieldParentPhone?.value.trim() || "";

      const payload = {
        [PROFILE_PK]: currentUser.id,    // ‚úÖ IMPORTANT
        [COL_PSEUDO]: pseudo,
        [COL_FULLNAME]: riderFirst,
        [COL_RIDERNAME]: riderLast,
        [COL_PHONE]: parentPhone,
        updated_at: new Date().toISOString()
      };

      setProfileStatus("Enregistrement en cours...", null);

      try{
        const { error } = await sb
          .from(PROFILE_TABLE)
          .upsert(payload, { onConflict: PROFILE_PK });

        if(error){
          console.warn("Erreur save profile:", error);
          setProfileStatus("Erreur lors de l‚Äôenregistrement du profil.", "err");
          return;
        }

        const stored = { pseudo, riderFirst, riderLast, parentPhone };
        setProfileLS(stored);
        updateProfileTextsFromObj(stored);
        setProfileStatus("Profil mis √† jour ‚úÖ", "ok");
      }catch(e){
        console.warn("Exception save profile:", e);
        setProfileStatus("Erreur lors de l‚Äôenregistrement du profil.", "err");
      }
    }

    async function uploadAvatar(file){
      if(!currentUser || !sb || !sb.storage){
        setProfileStatus("Tu dois √™tre connect√© pour changer ta photo.", "err");
        return;
      }
      if(!file) return;

      setProfileStatus("Upload de la photo en cours...", null);

      const fileExt = file.name.split(".").pop();
      const fileName = `avatar_${Date.now()}.${fileExt}`;
      const filePath = `${currentUser.id}/${fileName}`;

      try{
        const { error: uploadError } = await sb
          .storage
          .from(AVATAR_BUCKET)
          .upload(filePath, file, { upsert: true });

        if(uploadError){
          console.warn("Erreur upload avatar:", uploadError);
          setProfileStatus("Erreur lors de l‚Äôupload de la photo.", "err");
          return;
        }

        const { data: publicData } = sb
          .storage
          .from(AVATAR_BUCKET)
          .getPublicUrl(filePath);

        const publicUrl = publicData?.publicUrl;
        if(!publicUrl){
          setProfileStatus("Impossible de r√©cup√©rer l‚ÄôURL de la photo.", "err");
          return;
        }

        const { error: upsertError } = await sb
          .from(AVATAR_TABLE)
          .upsert({
            user_id: currentUser.id,
            avatar_url: publicUrl,
            updated_at: new Date().toISOString()
          }, { onConflict: "user_id" });

        if(upsertError){
          console.warn("Erreur upsert avatar table:", upsertError);
          setProfileStatus("Erreur lors de l‚Äôenregistrement de la photo.", "err");
          return;
        }

        if(navAvatar){
          navAvatar.src = publicUrl;
          navAvatar.style.display = "inline-block";
        }
        if(profileAvatar) profileAvatar.src = publicUrl;

        setAvatarLS(publicUrl);
        setProfileStatus("Photo de profil mise √† jour ‚úÖ", "ok");
      }catch(e){
        console.warn("Exception upload avatar:", e);
        setProfileStatus("Erreur lors de l‚Äôupload de la photo.", "err");
      }
    }

    // ==== Logout ====
    async function logout(){
      try{ if(sb && sb.auth) await sb.auth.signOut(); }catch(e){ console.warn("Erreur logout:", e); }
      localStorage.removeItem("rsl_profile");
      localStorage.removeItem("rsl_avatar");
      window.location.href = "index.html";
    }
    btnLogout?.addEventListener("click", logout);
    mobileLogout?.addEventListener("click", logout);

    // ==== Events profil ====
    btnSaveProfile?.addEventListener("click", saveProfileToSupabase);

    btnChangeAvatar?.addEventListener("click", ()=>{
      if(!currentUser){
        setProfileStatus("Connecte-toi avant de changer la photo.", "err");
        return;
      }
      avatarInput?.click();
    });

    avatarInput?.addEventListener("change", (e)=>{
      const file = e.target.files?.[0];
      if(file) uploadAvatar(file);
    });

    // ==== Init ====
    (async ()=>{
      applyAvatar();

      const profLS = getProfileLS();
      hydrateProfileFormFromObj(profLS);
      // pas d'affichage "Non connect√©" par d√©faut : on attend getUser()
      updateProfileTextsFromObj(profLS);

      if(!sb || !sb.auth){
        if(loginHint) loginHint.style.display = "inline-flex";
        return;
      }

      try{
        const { data:{ user } } = await sb.auth.getUser();
        currentUser = user || null;

        if(!user){
          if(profileName) profileName.textContent = "Non connect√©";
          if(profileEmail) profileEmail.textContent = "‚Äî";
          if(profilePhone) profilePhone.textContent = "T√©l√©phone : ‚Äî";
          if(loginHint) loginHint.style.display = "inline-flex";

          if(btnLoginEl) btnLoginEl.style.display = "inline-flex";
          if(btnAccount) btnAccount.style.display = "none";
          if(btnLogout) btnLogout.style.display = "none";
          if(mobileLogout) mobileLogout.style.display = "none";
          if(navAvatar) navAvatar.style.display = "none";

          membershipBox.textContent = "Connecte-toi pour voir ton abonnement.";
          membershipCoursesEl.textContent = "Connecte-toi pour voir tes cours.";
          paidCoursesEl.textContent = "Connecte-toi pour voir tes cours.";
          pendingCoursesEl.textContent = "Connecte-toi pour voir tes cours.";
          return;
        }

        if(btnLoginEl) btnLoginEl.style.display = "none";
        if(btnAccount) btnAccount.style.display = "inline-flex";
        if(btnLogout) btnLogout.style.display = "inline-flex";
        if(mobileLogout) mobileLogout.style.display = "block";
        if(loginHint) loginHint.style.display = "none";

        // Avatar visible si on a un avatar LS (sinon se montrera quand DB le donne)
        if(navAvatar){
          const av = getAvatarLS();
          navAvatar.style.display = av ? "inline-block" : "none";
        }

        // email direct
        if(profileEmail) profileEmail.textContent = user.email || "‚Äî";

        await loadProfileFromSupabase(user.id);
        await loadAvatarFromDb(user.id);

        const membership = await fetchMembership(sb, user.id);
        currentMembership = membership;
        renderMembershipBox(membership);

        await loadCourses();
      }catch(e){
        console.warn("Erreur init compte:", e);
        membershipBox.textContent = "Erreur lors du chargement de ton compte.";
      }
    })();
  </script>
</body>
</html>
