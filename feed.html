<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Feed Riders ‚Äî RSL</title>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --green:#22c55e;
    --green-dark:#16a34a;
    --panel:#0b1220;
    --border:rgba(255,255,255,.15);
    --dim:#9aa5b1;
  }
  *{box-sizing:border-box}

  html,body{height:100%}
  body{
    margin:0;
    background:#000;
    color:#fff;
    font-family:Outfit,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  }

  /* BG vid√©o */
  .bg-wrap{position:fixed;inset:0;z-index:0;pointer-events:none}
  .bg-video{
    position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000;
    filter:brightness(.45) saturate(1.05);
  }

  /* Header */
  header{
    position:sticky;top:0;z-index:10;
    display:flex;align-items:center;justify-content:space-between;
    padding:12px 14px;border-bottom:1px solid var(--border);
    background:rgba(0,0,0,.6);backdrop-filter:blur(8px);
  }
  header .brand{display:flex;align-items:center;gap:10px;color:#fff;text-decoration:none}
  header .brand img{height:34px;width:34px;border-radius:8px;background:#fff;padding:4px}
  header .brand b{font-size:16px}
  header .auth{font-size:13px;color:var(--dim);font-weight:600}
  header .auth a{color:var(--green);font-weight:800;text-decoration:none}

  .wrap{position:relative;z-index:1;max-width:980px;margin:0 auto;padding:10px 12px 88px}

  /* Flashs (stories) */
  .flash-bar{
    display:flex;gap:12px;overflow-x:auto;padding:8px 2px 2px 2px;margin-bottom:10px;scroll-snap-type:x proximity
  }
  .flash{
    scroll-snap-align:start;
    min-width:76px;width:76px;text-align:center;user-select:none;cursor:pointer
  }
  .flash .ring{
    width:66px;height:66px;border-radius:50%;margin:0 auto 6px;display:grid;place-items:center;
    background:
      radial-gradient(farthest-side,rgba(0,0,0,.7) 60%,transparent 62%) top/100% 100%,
      conic-gradient(#22c55e, #16a34a, #22c55e);
    padding:3px;
  }
  .flash .ring img{
    width:60px;height:60px;border-radius:50%;object-fit:cover;border:2px solid #000
  }
  .flash .name{
    font-size:12px;line-height:1.2;font-weight:700;color:#fff;max-width:72px;margin:0 auto
  }
  .flash.me .ring{background:
    radial-gradient(farthest-side,rgba(0,0,0,.7) 60%,transparent 62%) top/100% 100%,
    conic-gradient(#60a5fa,#22c55e,#60a5fa)
  }

  /* Lightbox flash */
  .lightbox{position:fixed;inset:0;z-index:50;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.8)}
  .lightbox.open{display:flex}
  .lightbox .content{
    max-width:min(92vw,780px);max-height:80vh;background:#000;border:1px solid var(--border);border-radius:12px;overflow:hidden
  }
  .lightbox header{
    position:relative;top:auto;background:#000;border:0;padding:10px 12px
  }
  .lightbox .media{display:block;max-width:100%;max-height:70vh;margin:0 auto;background:#000}
  .lightbox .cap{padding:10px 12px;font-size:13px;color:#e5e7eb;border-top:1px solid var(--border)}
  .lightbox .close{position:absolute;right:12px;top:10px;font-weight:800;color:#fff;background:transparent;border:0;font-size:18px;cursor:pointer}

  /* Feed cards */
  .post{
    background:rgba(0,0,0,.6);border:1px solid var(--border);border-radius:16px;padding:12px;margin:14px 0;
    box-shadow:0 30px 80px rgba(0,0,0,.8)
  }
  .post .head{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  .post .ava{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid #000;background:#111}
  .post .who{font-weight:800;font-size:14px}
  .post .spot{font-size:12px;color:var(--dim);font-weight:700}
  .media-wrap{border-radius:12px;overflow:hidden;border:1px solid var(--border);background:#000}
  .media{display:block;width:100%;max-height:64vh;object-fit:cover}
  .cap{font-size:14px;line-height:1.5;margin:8px 2px 0;color:#e5e7eb}
  .meta{display:flex;align-items:center;justify-content:space-between;margin-top:8px}
  .wheels{display:flex;gap:6px}
  .wheel{
    width:26px;height:26px;border-radius:50%;display:grid;place-items:center;border:2px solid #fff;background:#1f2937;cursor:pointer;font-weight:900;font-size:12px
  }
  .wheel.on{background:#22c55e;color:#062312;border-color:#22c55e}
  .avg{font-size:12px;color:#9ddbb0;font-weight:800}

  /* Bottom nav */
  .tabbar{
    position:fixed;
    left:0;right:0;bottom:0;
    z-index:2000;
    display:flex;
    align-items:center;
    justify-content:space-around;
    padding:10px 12px;
    border-top:1px solid var(--border);
    background:rgba(0,0,0,.78);
    backdrop-filter:blur(10px);
  }
  .tab{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
    text-decoration:none;
  }
  .tab .ic{font-size:20px}
  .tab span{font-size:11px;color:#e5e7eb;font-weight:700}
  .tab.active span{color:#22c55e}
  @media (min-width:900px){.tab span{font-size:12px}}
</style>
</head>
<body>

<div class="bg-wrap" aria-hidden="true">
  <video class="bg-video" id="bgVid" autoplay muted loop playsinline preload="auto"></video>
</div>

<header>
  <a class="brand" href="ou_rider.html">
    <img src="images/logo_rsl.png" alt="RSL"/>
    <b>RSL ‚Äî Feed Riders</b>
  </a>
  <div class="auth" id="authState">V√©rif session‚Ä¶</div>
</header>

<div class="wrap">
  <div class="flash-bar" id="flashBar"></div>

  <!-- UNIQUEMENT LE FEED, plus de formulaire ici -->
  <section id="feedList">
    <p style="color:#9aa5b1">Chargement du feed‚Ä¶</p>
  </section>
</div>

<!-- Lightbox Flash -->
<div class="lightbox" id="flashBox" role="dialog" aria-modal="true">
  <div class="content">
    <header>
      <div id="flashUser" class="who">Rider</div>
      <button class="close" id="flashClose">‚úï</button>
    </header>
    <img id="flashImg" class="media" alt="" style="display:none"/>
    <video id="flashVid" class="media" controls playsinline style="display:none"></video>
    <div id="flashCap" class="cap"></div>
  </div>
</div>

<!-- Bottom nav : Feed actif, + va sur ajouter.html -->
<nav class="tabbar" aria-label="Navigation">
  <a class="tab" href="ou_rider.html" title="Carte / Spots">
    <div class="ic">üè†</div><span>Spots</span>
  </a>
  <a class="tab" href="ajouter.html" title="Ajouter">
    <div class="ic">‚ûï</div><span>Ajouter</span>
  </a>
  <a class="tab active" href="feed.html" title="Vid√©os">
    <div class="ic">üé¨</div><span>Feed</span>
  </a>
  <a class="tab" href="recherche.html" title="Recherche">
    <div class="ic">üîé</div><span>Recherche</span>
  </a>
  <a class="tab" href="profil_ou_rider.html" title="Profil">
    <div class="ic">üë§</div><span>Profil</span>
  </a>
</nav>

<script>
/* Supabase init */
const SUPABASE_URL_FALLBACK = "https://jynxifufaauoxwzjapzq.supabase.co";
const SUPABASE_ANON_FALLBACK = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5bnhpZnVmYWF1b3h3emphcHpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzODI2NzcsImV4cCI6MjA3Njk1ODY3N30.vFPGhGakPIM3Xg5rn8_BrAXl6oJMJOssO780C9nXmr4";
const supa = supabase.createClient(
  window.env?.SUPABASE_URL || SUPABASE_URL_FALLBACK,
  window.env?.SUPABASE_ANON || SUPABASE_ANON_FALLBACK
);

/* BG video */
(function(){
  const vids=[
    `${SUPABASE_URL_FALLBACK}/storage/v1/object/public/videos_rsl/trottvideo1.mp4`,
    `${SUPABASE_URL_FALLBACK}/storage/v1/object/public/videos_rsl/trottvideo2.mp4`
  ];
  const v=document.getElementById('bgVid'); if(!v) return;
  const s=document.createElement('source');
  s.src=vids[Math.floor(Math.random()*vids.length)];
  s.type="video/mp4"; v.appendChild(s);
  const play=()=>{try{v.playbackRate=0.6;const p=v.play();if(p&&p.catch)p.catch(()=>{});}catch(e){}};
  play(); document.addEventListener('visibilitychange',()=>{document.hidden?v.pause():play();});
})();

/* State */
let me=null;
const authState=document.getElementById('authState');
const flashBar=document.getElementById('flashBar');
const feedList=document.getElementById('feedList');
const flashBox=document.getElementById('flashBox');
const flashUser=document.getElementById('flashUser');
const flashImg=document.getElementById('flashImg');
const flashVid=document.getElementById('flashVid');
const flashCap=document.getElementById('flashCap');
const flashClose=document.getElementById('flashClose');

/* Auth (pour likes + header) */
(async()=>{
  try{
    const { data:{ user } } = await supa.auth.getUser();
    if(user){
      me=user;
      const displayName=user.user_metadata?.full_name || user.email || "Rider";
      authState.innerHTML=`Connect√© : <b>${displayName}</b>`;
    }else{
      authState.innerHTML=`Pas connect√© ‚Äî <a href="compte.html">Se connecter</a>`;
    }
  }catch(e){
    authState.textContent="Session inconnue";
  }
})();

/* Flashes */
async function loadFlashes(){
  flashBar.innerHTML='';
  const nowIso=new Date().toISOString();
  try{
    const { data:fl } = await supa
      .from('flashes')
      .select('id,user_id,media_url,caption,created_at,expires_at,profiles!inner(full_name,avatar_url)')
      .gt('expires_at',nowIso)
      .order('created_at',{ascending:false})
      .limit(40);

    const list=fl||[];
    if(me){
      const my=document.createElement('div');
      my.className='flash me';
      my.innerHTML=`<div class="ring"><img src="${me.user_metadata?.avatar_url||'images/avatar_default.png'}" alt="Me"></div><div class="name">Moi</div>`;
      my.title='Pour ajouter une story : onglet "Ajouter".';
      flashBar.appendChild(my);
    }

    list.forEach(f=>{
      const name=f.profiles?.full_name || 'Rider';
      const ava=f.profiles?.avatar_url || 'images/avatar_default.png';
      const el=document.createElement('div');
      el.className='flash';
      el.innerHTML=`<div class="ring"><img src="${ava}" alt=""></div><div class="name">${name}</div>`;
      el.onclick=()=>openFlash(f);
      flashBar.appendChild(el);
    });
  }catch(e){}
}

function openFlash(f){
  flashUser.textContent=f.profiles?.full_name || 'Rider';
  flashCap.textContent=f.caption || '';
  flashImg.style.display='none'; flashVid.style.display='none';
  if(/\.(mp4|webm|mov)$/i.test(f.media_url||'')){
    flashVid.src=f.media_url; flashVid.style.display='block'; flashVid.currentTime=0; flashVid.play().catch(()=>{});
  }else{
    flashImg.src=f.media_url||''; flashImg.style.display='block';
  }
  flashBox.classList.add('open');
}
flashClose.onclick=()=>{flashBox.classList.remove('open');flashVid.pause();};

/* Feed */
async function loadFeed(){
  feedList.innerHTML='<p style="color:#9aa5b1">Chargement‚Ä¶</p>';
  try{
    const { data:posts } = await supa
      .from('spot_posts')
      .select('*')
      .order('created_at',{ascending:false})
      .limit(50);

    if(!posts || !posts.length){
      feedList.innerHTML='<p style="color:#9aa5b1">Encore aucun post. Sois le premier üëë</p>';
      return;
    }

    let html='';
    for(const p of posts){
      let spotLabel='Spot non li√©';
      if(p.spot_type==='park' && p.spot_id){
        const { data:sp } = await supa.from('spots').select('nom,ville,canton').eq('id',p.spot_id).maybeSingle();
        if(sp) spotLabel=`${sp.nom} ‚Äî ${sp.ville} (${sp.canton})`;
      }else if(p.spot_type==='street' && p.spot_id){
        const { data:sp } = await supa.from('bunny').select('nom,ville,canton').eq('id',p.spot_id).maybeSingle();
        if(sp) spotLabel=`${sp.nom} ‚Äî ${sp.ville} (${sp.canton})`;
      }

      let avgTxt='';
      try{
        const { data:likes } = await supa.from('post_likes').select('rating').eq('post_id',p.id);
        if(likes?.length){
          const sum=likes.reduce((a,b)=>a+(b.rating||0),0);
          const avg=sum/likes.length;
          avgTxt=`Moy: ${avg.toFixed(1)} / 5 (${likes.length})`;
        }else avgTxt='Pas encore not√©';
      }catch(_){}

      const isVideo=/\.(mp4|webm|mov)$/i.test(p.media_url||'');

      html+=`
      <article class="post">
        <div class="head">
          <img class="ava" src="images/avatar_default.png" alt="">
          <div>
            <div class="who">${escapeHTML(p.user_display||'Rider')}</div>
            <div class="spot">${escapeHTML(spotLabel)}</div>
          </div>
        </div>
        <div class="media-wrap">
          ${isVideo
            ? `<video class="media" controls playsinline src="${escapeAttr(p.media_url||'')}"></video>`
            : `<img class="media" src="${escapeAttr(p.media_url||'')}" alt="">`}
        </div>
        ${p.caption ? `<div class="cap">${escapeHTML(p.caption)}</div>` : ''}
        <div class="meta">
          <div class="wheels" data-post="${p.id}">
            ${[1,2,3,4,5].map(n=>`<button class="wheel" data-val="${n}" title="${n} roues">${n}</button>`).join('')}
          </div>
          <div class="avg" id="avg-${p.id}">${avgTxt}</div>
        </div>
      </article>`;
    }
    feedList.innerHTML=html;

    document.querySelectorAll('.wheels').forEach(box=>{
      box.addEventListener('click',async ev=>{
        const btn=ev.target.closest('.wheel'); if(!btn) return;
        if(!me){ alert('Connecte-toi pour noter.'); return; }
        const postId=Number(box.getAttribute('data-post'));
        const rating=Number(btn.getAttribute('data-val'));
        try{
          await supa.from('post_likes').upsert(
            [{post_id:postId,user_id:me.id,rating}],
            {onConflict:'post_id,user_id'}
          );
          const { data:likes } = await supa.from('post_likes').select('rating').eq('post_id',postId);
          if(likes?.length){
            const sum=likes.reduce((a,b)=>a+(b.rating||0),0);
            const avg=sum/likes.length;
            const el=document.getElementById('avg-'+postId);
            if(el) el.textContent=`Moy: ${avg.toFixed(1)} / 5 (${likes.length})`;
          }
          box.querySelectorAll('.wheel').forEach(w=>w.classList.remove('on'));
          btn.classList.add('on');
        }catch(e){
          alert('Impossible de noter pour le moment.');
        }
      });
    });
  }catch(e){
    feedList.innerHTML='<p style="color:#ef4444">Erreur chargement feed.</p>';
  }
}

/* Utils */
function escapeHTML(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
function escapeAttr(s){return escapeHTML(s)}

(async()=>{await loadFlashes();await loadFeed();})();
</script>
</body>
</html>